define(["libs","c","cBasePageView","text!templates/golf.list.html","cWidgetFactory","cWidgetGeolocation","GolfStore","GolfModel","res/scripts/widget/c.ui.imageSlider","cWidgetGuider"],function(a,b,c,d,e,f,g,h){"use strict";var i,j,k,l,m,n,o,p,q,r,s,t,u,v,w={},w={},x=20,y="上海",z="2",A="上海",B="2",C=e.create("Guider"),D=b.utility.isInApp(),E=(g.GeoLocationStore.getInstance(),["","D","P","T"]),F=["","vGlobal","vPrice","vDays"],G={vGlobal:0,vPrice:0,vDays:0},H={vGlobal:0,vPrice:0,vDays:0},I={vGlobal:0,vPrice:0,vDays:0},J={vGlobal:{},vPrice:{},vDays:{}},K=c.extend({pageid:"275002",pkgTravelsListModel:h.PkgTravelsListModel.getInstance(),render:function(a){var b=this.initTemplate();this.$el.html(b({data:a})),o=this.$el.find(".base_loading"),this._checkImgPos=$.proxy(this.checkImgPos,this)},initTemplate:function(){return _.template(d)},onCreate:function(){this.injectHeaderView(),this.render()},events:{"click .hot_vacation .feature":"showOrHideFeature","click .tpye_tab li":"tabSwitch","click .hot_list_tab":"detail","click .try_again":"tryAgain"},onLoad:function(){function a(){v.linetype=i,v.departCtyId=j||z,v.departCtyName=k||y,v.destCtyId=l||B,v.destCtyName=m||A,u.set(v),!v.renew&&w.products&&w.products.length&&(1==t&&b.pkgTravelsListModel.param.cityID==l||2==t&&b.pkgTravelsListModel.param.startCityID==j)?b.headerShow():(J[n]={},w={},b.getRenderDatas())}var b=this;s=$.os&&$.os.android,$(".product_list").html(""),$(".no_more").hide(),b.showLoading(),t=this.getQuery("prdcategory")&&!isNaN(this.getQuery("prdcategory"))?this.getQuery("prdcategory"):1,1==t?(this.pageid="275002",this.hpageid="276002"):2==t&&(this.pageid="275004",this.hpageid="276004"),u=1==t?g.PkgProdListParamStore.getInstance():g.TravelProdListParamStore.getInstance(),v=u.get()||{vGlobal:{},vPrice:{},vDays:{}},!!this.tabScrollY&&(G=this.tabScrollY),r=function(){b.onWindowScroll(b)},i=(this.getQuery("type")&&!isNaN(this.getQuery("type"))?this.getQuery("type"):v.linetype)||1,j=this.getQuery("salecity")||v.departCtyId||z,k=this.getQuery("sname")||v.departCtyName||y,l=this.getQuery("destctyid")||v.destCtyId||B,m=this.getQuery("destctyname")||v.destCtyName||A,v.frompage||(v.frompage=b.getQuery("from"),u.set(v)),n=F[i],w=J[n],b.headerReset(),this.turning(),a()},showOrHideFeature:function(a){a.stopImmediatePropagation(),$(a.target).closest(".hot_list_tab").toggleClass("feature_show")},onWindowScroll:function(a){function b(){var b=$("#headerview")[0].clientHeight+$(".product_list")[0].clientHeight;p+$(window).height()>b&&(0,!H[n]&&w.products&&a.addmore())}!w.products||o.height()||H[n]||o.show(),2==H[n]?($(window).unbind("scroll",r),!!w.products&&$(".no_more").show()):(p=document.documentElement.scrollTop||document.body.scrollTop,clearTimeout(q),q=setTimeout(b,300))},addmore:function(a,b){var c=this;I[n]+=x,c.pkgTravelsListModel.param.pageIndex=I[n]/x;var d=E[v.linetype];c.pkgTravelsListModel.param={productCategory:t?t:1,cityID:v.destCtyId?v.destCtyId:-1,startCityID:v.departCtyId?v.departCtyId:-1,sortType:d,sortDirection:"DESC",pageIndex:I[n]/x+1,pageSize:x},c.pkgTravelsListModel.execute(function(a){if(c.pkgTravelsListModel.param.sortType==E[v.linetype]){if(H[n]=1,a.destCtyId=c.pkgTravelsListModel.param.cityID,a.departCtyId=c.pkgTravelsListModel.param.startCityID,a.isInApp=D,a.isAndroid=s,a.tourProducts&&a.tourProducts.length){var d='<%_.each(data.tourProducts, function(v,k){%>                            <ul class="hot_list_tab btn_active" data-pid="<%=v.productID %>&saleCityId=<%=v.saleCities.cityID %>&departCityId=<%=v.departCities.cityID %>">                            <li class="hot_img">                            <img width="142px" height="80px" alt="" src="http://pic.c-ctrip.com/vacation_v2/h5/group_travel/no_product_pic.png" data-src="<% if(!!data.isAndroid && v.androidPicUrl && !!v.androidPicUrl.trim()){%><%=v.androidPicUrl%> <%}else if(!data.isAndroid && v.iphonePicUrl && !!v.iphonePicUrl.trim()){%><%=v.iphonePicUrl%><%}else{ %>http://pic.c-ctrip.com/vacation_v2/h5/group_travel/no_product_pic.png<%} %>">                            </li>                            <li class="hot_vacation">                            <div class="ellipsis"><p class="xname"><%=v.name%></p></div>                            <div class="price_wrap">                            <div class="pices">                            <%if(!!v.price){ %>                            <dfn>¥</dfn>                            <span><%=v.price%></span>起                            <%}else{ %>                            <span class="font14">实时计价</span>                            <%} %>                            </div>                            <div class                            ="feature">                            <span>产品特色</span><i class=""></i>                            </div>                            </div>                            </li>                            <li class="product_feature">                            <%_.each(v.features, function(fv,fk){%>                            <p><%=fv%></p>                            <%})%>                            <%})%>',e=_.template(d),f=$(e({data:a}));c.$el.find(".product_list").append(f),c.correctImage(f);var g=J[n];g.products=(g.products&&g.products.length?g.products:[]).concat(a.tourProducts),a.tourProducts&&a.tourProducts.length==x?H[n]=0:(H[n]=2,$(".no_more").show())}else H[n]=2,$(".no_more").show();b&&"function"==$.type(b)&&b.apply(null),o.hide()}},function(){H[n]=2,$(".no_more").show(),o.hide()},!1,this)},correctImage:function(a){var b=$("img",a);b.each(function(a,b){var c=$(b);b.onload=function(){c.show("fast")},b.onerror=function(){c.attr("src","http://pic.c-ctrip.com/vacation_v2/h5/group_travel/no_product_pic.png")}})},tabSwitch:function(a){$(window).unbind("scroll"),G[F[v.linetype]]=window.scrollY;var b=this,c=a.target||a.srcElement,d=$(c);d.hasClass("on")||(d.addClass("on"),d.siblings("li").removeClass("on"),v.linetype=d.data("linetype"),u.set(v),this.getQuery("type")?b.back():b.onLoad())},detail:function(a){G[n]=window.scrollY,$(".tpye_tab").show();var b="#detail?productId="+$(a.currentTarget).data("pid")+"&from=/webapp/golf/index.html#golf.list?prdcategory="+t;D?C.cross({path:"tour",param:"index.html"+b}):window.location.href="http://m.ctrip.com/webapp/tour/index.html"+b},headerUpdate:function(a){var b=this;b.headerview.set({title:a.title,subtitle:a.subtitle,customtitle:a.customtitle,back:!0,view:this,tel:null,home:a.home,custom:a.custom?a.custom.html:"",btn:a.btn,bindEvents:function(b){a.custom&&a.custom.class&&b.on("click",a.custom.class,a.custom.func),a.btn&&a.btn.classname&&b.on("click","."+a.btn.classname,a.btn.func)},events:{returnHandler:a.returnfunc,homeHandler:a.homefunc},commit:a.commit}),b.headerview.show()},showToast:function(a,c){c||(c=function(){}),this.toast||(this.toast=new b.ui.Toast),this.toast.show(a,2,c,!0)},headerReset:function(){var a,b,c=this;1==t?(a=(v&&v.destCtyName?v.destCtyName:A)+">",b="套餐"):2==t&&(a=v&&v.departCtyName?v.departCtyName+"出发>":y+"出发",b="旅行");var d={title:b,home:!1,btn:{title:a,id:"confirmBtn",classname:"header_r"},homefunc:function(){v.frompage=void 0,u.set(v),IWanUtil.app_back_to_home()},returnfunc:function(){var a=v.frompage||"";if(v.frompage=void 0,u.set(v),"nopage"==a)D?C.backToLastPage({}):c.back();else if(/\/webapp\/(\S+)\/(\S+)/.test(a)){var b=a.match(/\/webapp\/(\S+)\/(\S+)/);D?C.cross({path:b[1],param:b[2]}):window.location=b[0]}else this.back(a||"#index")},commit:{id:"confirmBtn",callback:function(){c.forward("#golf.city?prdcategory="+t)}}};c.headerUpdate(d,1)},headerShow:function(){var a=this;a.headerReset(),a.hideLoading(),a.render(w),a.turning(),w.products&&w.products.length<x&&(H[n]=2,$(".no_more").show()),$(window).bind("scroll",r)},getRenderDatas:function(){var a=this;w.isInApp=D,w.isAndroid=s,(v.renew||1==t?a.pkgTravelsListModel.param.cityID!=l:a.pkgTravelsListModel.param.startCityID!=j)&&(v.renew=0,v.vGlobal={},v.vPrice={},v.vDays={},u.set(v),G={vGlobal:0,vPrice:0,vDays:0},H={vGlobal:0,vPrice:0,vDays:0},I={vGlobal:0,vPrice:0,vDays:0},J={vGlobal:{},vPrice:{},vDays:{}});var b=E[v.linetype];a.pkgTravelsListModel.param={productCategory:t?t:1,cityID:v.destCtyId?v.destCtyId:-1,startCityID:v.departCtyId?v.departCtyId:-1,sortType:b,sortDirection:"DESC",pageIndex:1,pageSize:x},a.pkgTravelsListModel.execute(function(b){w.products=b.tourProducts,w.linetype=i,w.destCtyId=a.pkgTravelsListModel.param.cityID,w.departCtyId=a.pkgTravelsListModel.param.startCityID,w.productCategory=a.pkgTravelsListModel.param.productCategory,w.isInApp=D,w.isAndroid=s,w.scrollproductHeight=document.body.offsetHeight-48,J[n]=w,b.tourProducts&&b.tourProducts.length==x?H[n]=0:(H[n]=2,$(".no_more").show()),a.headerShow()},function(){a.hideLoading(),a.render({isInApp:D}),$(".wireless_failure").show(),$(".error").hide()},!1,this)},checkImgPos:function(){var a=this,b=this.$el.find(".product_list");if(b.find("img").length){var c=b.find("ul");c.each(function(b,c){document.body.scrollTop+document.body.offsetHeight>$(c).offset().top&&a.loadImgsInDom($(c))})}},loadImgsInDom:function(a){if(!(a.length<1)){"array"!=$.type(a)&&(a=$(a));var b=$("img",a);b.each(function(a,b){var c=$(b),d=c.attr("data-src");c.attr("src")!=d&&(c.css("display","none"),b.onload=function(){c.show()},b.onerror=function(){c.show()},c.attr("src",d))})}},tryAgain:function(){this.onLoad()},onShow:function(){this.$el.find(".product_list").length&&($(window).bind("scroll",this._checkImgPos),$(window).bind("touchmove",this._checkImgPos)),this.checkImgPos();this.correctImage($(".product_list"))},onHide:function(){}});return K});