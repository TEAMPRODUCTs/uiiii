define(["libs","c","cBasePageView","text!templates/city.html","cWidgetFactory","cWidgetGeolocation","cUICitylist","GolfModel","GolfStore","text!templates/destinationSearch.html"],function(a,b,c,d,e,f,g,h,i,j){function k(a,b,c){for(var d=0,e=a.length;e>d;d++)if(b.city==a[d].city){a.splice(d,1);break}for(a.unshift(b);a.length>c;)a.pop();return a}var l,m,n,o,p,q,r,s,t,u,v,w=i.GeoLocationStore.getInstance(),x={},y=c.extend({pageid:"275003",cityListModel:h.CityListModel.getInstance(),render:function(a){var b=this.initTemplate();this.$el.html(b({data:a}))},onCreate:function(){this.injectHeaderView()},events:{"click .associate":"citySelect","click .area_title":"showCity","click .item_select":"citySelect","click #keyword":"doClick","focus #keyword":"doFocus","input #keyword":"placeSearch","click .search_history":"cityChoose","click .re_history":"resetHistory","click .cancel":"backFun","click .clear_input2":"clearInput","touchstart .search_content":"mouseInSearchContent"},onLoad:function(){var a=this;m=b.utility.isInApp(),n=$.os&&$.os.android,p=this.getQuery("prdcategory")&&!isNaN(this.getQuery("prdcategory"))?this.getQuery("prdcategory"):1;var c;1==p?(q=i.PkgCityHistoryStore.getInstance(),r=i.PkgProdListParamStore.getInstance(),s=i.PkgCityListStore.getInstance(),c="选择目的地",this.pageid="275003",this.hpageid="276003"):(q=i.TravelCityHistoryStore.getInstance(),r=i.TravelProdListParamStore.getInstance(),s=i.TravelCityListStore.getInstance(),c="选择出发地",this.pageid="275005",this.hpageid="276005"),t=q.get()||{},u=s.get()||{},a.showLoading(),this.headerview.set({title:c,back:!0,view:this,tel:null,events:{returnHandler:function(){this.back()}}}),t=q.get()||{},l=r.get()||{departCtyName:"",departCtyId:"",destCtyName:"",destCtyId:"",renew:1,vGlobal:{},vPrice:{},vDays:{}},u&&u.zimu&&u.zimu.length?(a.render(u),a.hideLoading(),this.headerview.show(),!v&&this.turning(),!!v&&(v=0)):this.getCityList()},initTemplate:function(){return _.template(d)},getCityList:function(){var a=this,b=w.get()||{};a.cityListModel.param={productCategory:p?p:1},a.cityListModel.execute(function(c){if(c&&c.cities){x=c.cities,a.Locating(),cityList_format=a.cityDataFormat(c);var d={cities:c,zimu:cityList_format,hideCurrent:0,selectedDepart:document.selectedDepart||{}};b.name?(d.geoLocation=b,d.hideCurrent=0):b.fail||(d.geoLocation={name:"定位中...",id:0},setTimeout(function(){b=w.get()||{},b.fail&&$(".currentcity").hide(),u.geoLocation=b,u.hideCurrent=b.fail,s.set(u)},2e4)),d.destinationSeleHistory=t.destinationSeleHistory&&t.destinationSeleHistory.length?t.destinationSeleHistory:void 0,q.set(t),u=d,s.set(u),a.render(d),a.hideLoading(),setTimeout(function(){a.hideLoading()},0),a.headerview.show(),!v&&a.turning(),!!v&&(v=0)}},function(){a.hideLoading()},!1,this)},citySelect:function(a){var b=a.target||a.srcElement;this.setProdListParm(b)},showCity:function(a){var b=$(a.currentTarget);b.toggleClass("area_cur"),b.next(".item_select").toggleClass("hidden"),b.hasClass("alphabet")&&b.siblings(".alphabet").removeClass("area_cur").next(".item_select").addClass("hidden"),b.hasClass("area_cur")&&window.scroll(0,b[0].offsetTop)},searchresult:function(a){var b=this;a&&a.stopImmediatePropagation(),$(".cancel").show(),$("#destinationSearch").attr("class","search_header"),!m&&$("#headerview").hide(),$(".city_box").hide(),$(".search_content").removeClass("hidden"),b.showDestSearch()},doFocus:function(a){var b=this;n?o=setTimeout(function(){b.searchresult(a)},500):this.searchresult(a)},doClick:function(a){clearTimeout(o),this.searchresult(a)},onShow:function(){},onHide:function(){!m&&$("#headerview").show()},showDestSearch:function(){this.headerview.set({}),this.headerview.html="",this.headerview.show()},renderDestinationSearch:function(a){var b=_.template(j);this.$el.html(b({data:a}))},placeSearch:function(a){$(".associate").html("");var b=$(a.currentTarget).val().toLowerCase();b&&b.trim().length?($(".sub_box").hide(),$(".clear_input2").show()):this.clearInput();var c,d=[],e=[],f=u&&u.cities&&u.cities.cities?u.cities.cities:{};if(b&&b.trim().length){for(var g=0,h=f.length;h>g;g++)c=f[g],$.inArray(c.cityName,e)<0&&(c.cityName.indexOf(b)>-1||0==c.pinYin.indexOf(b))&&(e.push(c.cityName),d.push('<li class="cityitem" data-ruler="item" data-id="'+c.cityID+'">'+c.cityName+"</li>"));d.length?($(".no_result").hide(),$(".associate").html(d.join(""))):$(".no_result").show()}},setProdListParm:function(a){$(a).data("id")&&(l.departCtyName=$(a).text(),l.departCtyId=$(a).data("id"),l.destCtyId=$(a).data("id"),l.destCtyName=$(a).text(),r.set(l),t.destinationSeleHistory||(t.destinationSeleHistory=[]),t.destinationSeleHistory=k(t.destinationSeleHistory,{city:$(a).text(),id:$(a).data("id")},3),u.destinationSeleHistory=t.destinationSeleHistory,s.set(u),q.set(t),this.forward("#golf.list?prdcategory="+p+"&destctyid="+l.destCtyId+"&destctyname="+l.destCtyName+"&salecity="+l.departCtyId+"&sname="+l.departCtyName+"&from=/webapp/golf/index.html#golf.city"))},cityChoose:function(a){!m&&$("#headerview").show();var b=a.target||a.srcElement;this.setProdListParm(b)},resetHistory:function(){t.departSearHistory=void 0,q.set(t),this.onLoad()},backFun:function(a){!m&&$("#headerview").show(),_title=1==p?"选择目的地":"选择出发地",this.headerview.set({title:_title,back:!0,view:this,tel:null,events:{returnHandler:function(){this.back()}}}),this.headerview.show(),a.preventDefault(),$(".search_text").blur(),$(".city_box").show(),$(".search_content").addClass("hidden"),$(".cancel").hide(),$("#destinationSearch").attr("class","top_box destination_search starting_top")},clearInput:function(){$(".no_result").hide(),$(".associate").html(""),$(".search_text").val(""),!m&&$(".search_text").focus(),$(".clear_input2").hide()},mouseInSearchContent:function(){$(".search_text").blur()},cityDataFormat:function(a){var b=[];if(a){var c=_.groupBy(a.cities,function(a){var b=a.pinYin.toLowerCase();return b.substring(0,1)});_.each(c,function(a,c){b.push({initial:c.toUpperCase(),data:a})}),b=_.sortBy(b,function(a){return a.initial})}return b},Locating:function(){if(geoLocation=w.get()||{},!geoLocation.name){geoLocation.startLocating=1;var a=!1;w.set(geoLocation),GeoLocationWidget=e.create("Geolocation"),GeoLocationWidget.requestCityInfo(function(b){for(var c=0,d=x.length;d>c;c++)if(b.city.indexOf(x[c].cityName)>-1){geoLocation={name:x[c].cityName,id:x[c].cityID},a=1,$("#curcity").text(geoLocation.name),$("#curcity").data("id",geoLocation.id);break}a||(geoLocation={fail:1},a=1),w.set(geoLocation)},function(){geoLocation={fail:1},w.set(geoLocation)})}}});return y});