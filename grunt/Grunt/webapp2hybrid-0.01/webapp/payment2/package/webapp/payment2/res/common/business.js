define(["c","cWidgetFactory","PayStore","CommonStore","cUtility","paymentPipe","Util"],function(e,t,n,r,i,s,o){var u=n.PayMentCardParamStore.getInstance(),a=n.OrderDetailStore.getInstance(),f=n.ExtendInfoStore.getInstance(),l=n.PayMentOtherInfo.getInstance(),c=n.Ali_ReStore.getInstance(),h=n.ToAliFlagStore.getInstance(),p=n.tktErrorStore.getInstance(),d=n.PaymentWayStore.getInstance(),v=n.SelectBankStore.getInstance(),m=n.lipinCardEInfo.getInstance(),g=n.CashPayInfoStore.getInstance(),y=e.base,b=y.Date,w=n.ParamUrlTokenStore.getInstance(),E=r.HeadStore.getInstance(),S=t.create("Guider"),x="",T={alertArr:[],lipinCardExcuteCallback:function(e){return e&&e.rc&&e.rc==5?!1:!0},matchModuleFn:function(e){var t="",n=[],r="";return/webapp.+[^\/]/gi.test(e)&&(r=e.match(/webapp.+[^\/]/gi)[0],n=r.split("/"),n.length>1&&(t=n[1])),t},jump2App:function(e){if(e){var t=e.split("#");if(t.length>1){var n=T.matchModuleFn(t[0]),r=t[1];n&&r&&S.cross({path:n,param:"index.html#"+r})}}},getAppPath:function(e){if(e){var t=e.split("#");if(t.length>1){var n=T.matchModuleFn(t[0]),r=t[1];if(n&&r)return n+"/index.html#"+r}}return""},appendQuery:function(e,t){var n=e+"&"+t||"";return n.replace(/[&?]{1,2}/,"?")},getJump2SuccessPageQueryStr:function(e){var t="",n="",r="",i="",s="",o="",u=a.get()||{};u.extno&&(t=u.extno),e.bilno&&(n=e.bilno),u.realpaytype&&(r=u.realpaytype),l.get()&&l.getAttr("realoid")!=0?i=l.getAttr("realoid"):i=u.oid,u.bustype&&(s=u.bustype),u.totalamount&&(o=u.totalamount);var f="".concat("externalNo="+t).concat("&").concat("billNo="+n).concat("&").concat("payType="+r).concat("&").concat("busType="+s).concat("&").concat("price="+o).concat("&").concat("orderID="+i);return f},getJump2FailPageQueryStr:function(e){var t="",n="",r="",i="",s="",o="",u="",f=a.get()||{};f.extno&&(t=f.extno),e.bilno&&(n=e.bilno),l.get()&&l.getAttr("realoid")!=0?r=l.getAttr("realoid"):r=f.oid,i=e.rc,s=e.rmsg,f.bustype&&(o=f.bustype),f.totalamount&&(u=f.totalamount);var c="".concat("externalNo="+t).concat("&").concat("billNo="+n).concat("&").concat("orderID="+r).concat("&").concat("ErrorCode="+i).concat("&").concat("busType="+o).concat("&").concat("price="+u).concat("&").concat("ErrorMessage="+s);return c},jump2AppPage:function(e,t,n){if(n&&t){if(e)var r=T.getJump2SuccessPageQueryStr(t);else var r=T.getJump2FailPageQueryStr(t);n=T.appendQuery(n,r),T.jump2App(n)}},jump2H5Page:function(e,t,n){n=decodeURIComponent(n);if(e)var r=T.getJump2SuccessPageQueryStr(t);else var r=T.getJump2FailPageQueryStr(t);var i=T.appendQuery(n,r);location.href=i},H5Pay:function(t,n,r){var i=this,s=t;if(typeof s.res!="undefined"&&s.res){i.hideLoading(),i.showToast("网络不给力,请稍候重试");return}if(t&&t["rc"]==0){var o=t.paymentwayid;if(o=="EB_MobileAlipay"){var u=t.thirdpartyinfo&&t.thirdpartyinfo.sig;if(i.AliMclient){u=u.replace(/\"/g,"").split("&");var f=null,l="";for(var h=0,p=u.length;h<p;h++)f=u[h].split("="),f[0]=="sign"?l+=f[0]+"="+f[1]+"&":l+=f[0]+"="+encodeURIComponent(f[1])+"&";u=l.substr(0,l.length-1),h=p=f=l=i.AliMclient=null}window.location.href=u;return}if(o=="WechatScanCode"){var v=t.thirdpartyinfo.sig,m=JSON.parse(v);typeof WeixinJSBridge=="undefined"?i.showToast("请通过微信访问"):WeixinJSBridge.invoke("getBrandWCPayRequest",m,function(e){WeixinJSBridge.log(e.err_msg);if(e.err_msg=="get_brand_wcpay_request:ok")location.href=n;else{e.err_msg=="get_brand_wcpay_request:cancel"&&!a.getAttr("rback")?(T.removePayCardStore(),T.goHome.call(i)):location.href=r;try{Business.exceptionInfoCollect({bustype:a.getAttr("bustype"),excode:3,extype:3,exdesc:"微信报错,错误信息为："+e.err_msg+",orderid:"+a.getAttr("oid")})}catch(t){}}})}}else if(s.rc<100){c.setAttr("requestid","");if(s.rc==4){var g=new e.ui.Alert({title:"提示信息",message:s.rmsg||"网络不给力,请稍候重试",buttons:[{text:"好的",click:function(){T.jump2H5Page(!0,s,n)},type:e.ui.Alert.STYLE_CONFIRM}]});g.show(),T.alertArr.push(g)}else if(s.rc==7){var g=new e.ui.Alert({title:"提示信息",message:s.rmsg||"网络不给力,请稍候重试",buttons:[{text:"确定",click:function(){g.hide(),d.setAttr("verifiedPhone",null),T.PostCheck.call(i,0,t,n,r)},type:e.ui.Alert.STYLE_CONFIRM}]});g.show(),T.alertArr.push(g)}else i.hideLoading(),i.showToast(s.rmsg||"网络不给力,请稍候重试")}else T.jump2H5Page(!1,s,r)},AppPay:function(t,n,r,i,s,o,u){var f=this;if(typeof t.res!="undefined"&&t.res){f.showToast("网络不给力,请稍候重试");return}var l=T.getAppPath(n),c="",h=T.getAppPath(i);r&&(c=T.getAppPath(r));var p,v=t&&t.resultBody&&(p=JSON.parse(t.resultBody)),m=p;if(v&&p["rc"]==0){payAppName=s;var g=p.thirdpartyinfo.sig;S.pay.payOut({payAppName:payAppName,payURL:g,successRelativeURL:l,detailRelativeURL:c})}else if(m.rc<100)if(m.rc==4){var y=new e.ui.Alert({title:"提示信息",message:m.rmsg||"网络不给力,请稍候重试",buttons:[{text:"好的",click:function(){var e=decodeURIComponent(a.getAttr("sback"));T.jump2AppPage(!0,m,e)},type:e.ui.Alert.STYLE_CONFIRM}]});y.show(),T.alertArr.push(y)}else if(m.rc==7){var y=new e.ui.Alert({title:"提示信息",message:m.rmsg||"网络不给力,请稍候重试",buttons:[{text:"确定",click:function(){y.hide(),d.setAttr("verifiedPhone",null),T.PostCheck.call(f,1,t,n,r,i,s,o,u)},type:e.ui.Alert.STYLE_CONFIRM}]});y.show(),T.alertArr.push(y)}else f.hideLoading(),f.showToast(m.rmsg||"网络不给力,请稍候重试");else{var b=decodeURIComponent(a.getAttr("eback"));T.jump2AppPage(!1,m,b)}},jumpToAlipay:function(){x="Alipay";var t=this,n=T;if(!i.isInApp())if(a&&a.get()){t.showLoading(),t.AliMclient=0;var r=T.getRequestHeader(),s=function(){t.hideLoading(),t.showToast("网络不给力,请稍后再试试吧")},o=function(n){t.hideLoading();if(n!=null){if(!T.lipinCardExcuteCallback.call(null,n)){p.setAttr("tktUsed",1);var r=new e.ui.Alert({title:"提示信息",message:"支付失败，请重新尝试",buttons:[{text:"确定",click:function(){var e=location.hash.split("?")[0].replace("#","");e!="index"?(T.removePayCardStore(),T.goHome.call(t)):window.location.reload()},type:e.ui.Alert.STYLE_CONFIRM}]});r.show(),T.alertArr.push(r);return}T.setTempOid(n),n.bilno&&a.setAttr("bilno",n.bilno),n.ErrorCode&&a.setAttr("ErrorCode",n.rc),n.ErrorMessage&&a.setAttr("ErrorMessage",n.rmsg),n.paymentwayid="EB_MobileAlipay";var i=decodeURIComponent(a.getAttr("sback")),s=decodeURIComponent(a.getAttr("eback"));T.H5Pay.call(t,n,i,s)}else t.showToast("网络不给力,请稍后再试试吧")},u=t.getViewHash();aliTypeid=3;if(u=="index"||u=="selectpayment")aliTypeid=4,t.AliMclient=1;var f={opttype:1,paytype:4,thirdpartyinfo:{paymentwayid:"EB_MobileAlipay",typeid:0,subtypeid:aliTypeid,typecode:h.getAttr("bankcode")||"",thirdcardnum:h.getAttr("thirdcardnum")||"",amount:a.getAttr("amount")}};n.handlePay(f,o,JSON.stringify(r),s)}else t.showToast("网络不给力,请稍后再试试吧");else m.setAttr("flag_lipincard",""),T.checkAppCallBack.call(t,[])},checkAppCallBack:function(t){var n=!1,r=this,s=0,o=function(){r.hideLoading(),r.showToast("网络不给力,请稍后再试试吧")},u=function(t){t=t||{};var n=null;r.hideLoading();if(t&&t.errorInformation){r.showToast(t.errorInformation);return}i.isInApp()?(n=t.resultBody,n=$.parseJSON(n)):n=t;if(!T.lipinCardExcuteCallback.call(null,n)){p.setAttr("tktUsed",1);var s=new e.ui.Alert({title:"提示信息",message:"支付失败，请重新尝试",buttons:[{text:"确定",click:function(){var e=location.hash.split("?")[0].replace("#","");e!="index"?(T.removePayCardStore(),T.goHome.call(r)):window.location.reload()},type:e.ui.Alert.STYLE_CONFIRM}]});s.show(),T.alertArr.push(s);return}T.setTempOid(n);if(n!=null){var o=decodeURIComponent(a.getAttr("sback")),u=decodeURIComponent(a.getAttr("rback")),f=decodeURIComponent(a.getAttr("eback")),l=T.getJump2SuccessPageQueryStr(n),c=T.getJump2FailPageQueryStr(n);o=T.appendQuery(o,l),f=T.appendQuery(f,c),T.AppPay.call(r,t,o,u,f,payWayName,payWayId,subPayId)}else r.showToast("网络不给力,请稍后再试试吧")};if(t!=null){if(x=="Alipay"){var f=h.getAttr("is_wap");f?(payWayId="EB_MobileAlipay",payWayName="wapAliPay",subPayId=0,s=0):(payWayName="aliCounter",subPayId=4,payWayId="EB_MobileAlipay",s=0),n=!0}if(x=="weixinPay")if(t["weixinPay"]==1)payWayId="WechatScanCode",payWayName="weixinPay",subPayId=0,n=!0,s=0;else{var l=new e.ui.Alert({title:"提示信息",message:"您尚未安装微信，是否现在下载安装？",buttons:[{text:"取消",click:function(){this.hide()},type:e.ui.Alert.STYLE_CANCEL},{text:"确定",click:function(){var e="";t["platform"].toUpperCase()=="IOS"?e="http://itunes.apple.com/cn/app/id414478124":t["platform"].toUpperCase()=="ANDROID"&&(e="http://weixin.qq.com/m"),e!=""&&S.jump({url:e,targetModel:"browser"}),this.hide()},type:e.ui.Alert.STYLE_CONFIRM}]});l.show(),T.alertArr.push(l)}if(n)if(a&&a.get()){var c=T.getRequestHeader(),d={opttype:1,paytype:4,thirdpartyinfo:{paymentwayid:payWayId,typeid:s,subtypeid:subPayId,typecode:h.getAttr("bankcode")||"",thirdcardnum:h.getAttr("thirdcardnum")||"",amount:a.getAttr("amount")}};r.showLoading();try{T.handlePay(d,u,JSON.stringify(c),o)}catch(v){}}else r.showToast("网络不给力,请稍后再试试吧")}},jumpToWeiXinpay:function(){x="weixinPay";var t=this;if(i.isInApp())m.setAttr("flag_lipincard",""),S.pay.checkStatus({callback:$.proxy(T.checkAppCallBack,t)});else if(o.isInWeichat())if(a&&a.get()){t.showLoading();var n=T.getRequestHeader(),r={opttype:1,paytype:4,thirdpartyinfo:{paymentwayid:"WechatScanCode",typeid:0,subtypeid:1,typecode:"",amount:a.getAttr("amount")}},s=function(n){t.hideLoading();if(n!=null){if(!T.lipinCardExcuteCallback.call(null,n)){p.setAttr("tktUsed",1);var r=new e.ui.Alert({title:"提示信息",message:"支付失败，请重新尝试",buttons:[{text:"确定",click:function(){var e=t.getViewHash();e!="index"?(T.removePayCardStore(),T.goHome.call(t)):window.location.reload()},type:e.ui.Alert.STYLE_CONFIRM}]});r.show(),T.alertArr.push(r);return}T.setTempOid(n),n.bilno&&a.setAttr("bilno",n.bilno),n.ErrorCode&&a.setAttr("ErrorCode",n.rc),n.ErrorMessage&&a.setAttr("ErrorMessage",n.rmsg),n.paymentwayid="WechatScanCode";var i=decodeURIComponent(a.getAttr("sback")),s=decodeURIComponent(a.getAttr("eback"));T.H5Pay.call(t,n,i,s)}else t.showToast("网络不给力,请稍后再试试吧")},u=function(){t.hideLoading(),t.showToast("网络不给力,请稍后再试试吧")};T.handlePay(r,s,JSON.stringify(n),u)}else t.showToast("网络不给力,请稍后再试试吧")},toJiFenPay:function(){var t=this,n=T,r=f&&f.get()||{},s="您确认使用<span class='corange'>"+r.integralGuranteeAmount+"</span>积分用于此订单担保（担保积分将被暂时冻结）？",o=new e.ui.Layer({onCreate:function(){this.contentDom.html('<div class="cui-pop-box"><div class="cui-hd">积分担保<div id="jifen-grayload-close" class="cui-grayload-close" ></div></div><div class="cui-bd"><div class="p10">'+s+'</div><button class="paybtn w100" id="jiFenPayBtn">确认使用积分担保</button></div>');var e=this.contentDom.find("#jifen-grayload-close");e.click(function(){o.remove()});var t=this.contentDom.find("#jiFenPayBtn");t.click(function(){o.remove(),u()})},onShow:function(){},onHide:function(){}});o.show();var u=function(){var e=null,r=a.get()||{},s=decodeURIComponent(r.sback),o=f&&f.get(),u=decodeURIComponent(r.eback),l=d.get()||{},c=l.guarantee&&l.guarantee.length&&l.guarantee[0].paymentwayid,h=o.integralGuranteeAmount||0;t.showLoading(),e={opttype:1,paytype:64,guarantee:[{paymentwayid:c,amount:h}]},e.payrestrict=o.payrestrict;var p=n.getRequestHeader(),v=JSON.stringify(p),m=function(e){e=e||{};if(i.isInApp()){if(!e.resultBody){t.hideLoading(),t.showToast("网络不给力,请稍候重试");return}e=JSON.parse(e.resultBody)}if(typeof e.res!="undefined"&&e.res){t.hideLoading(),t.showToast("网络不给力,请稍候重试");return}e.rc==0?i.isInApp()?n.jump2AppPage(!0,e,s):n.jump2H5Page(!0,e,s):e.rc<100?(t.hideLoading(),t.showToast(e.rmsg||"网络不给力,请稍候重试")):i.isInApp()?n.jump2AppPage(!1,e,u):n.jump2H5Page(!1,e,u)};n.handlePay(e,m,v,function(){t.hideLoading(),t.showToast("网络不给力,请稍候重试")})}},toCashPayFn:function(t){function o(){var e=null,t=a.get()||{},s=decodeURIComponent(t.sback),o=f&&f.get()||{},u=decodeURIComponent(t.eback);n.showLoading(),e={opttype:1,paytype:16,cashinfo:[{amount:t.amount}]},e.payrestrict=o.payrestrict;var l=r.getRequestHeader(),c=JSON.stringify(l),h=function(e){e=e||{};if(i.isInApp()){if(!e.resultBody){n.hideLoading(),n.showToast("网络不给力,请稍候重试");return}e=JSON.parse(e.resultBody)}if(typeof e.res!="undefined"&&e.res){n.hideLoading(),n.showToast("网络不给力,请稍候重试");return}e.rc==0?i.isInApp()?r.jump2AppPage(!0,e,s):r.jump2H5Page(!0,e,s):e.rc<100?(n.hideLoading(),n.showToast(e.rmsg||"网络不给力,请稍候重试")):i.isInApp()?r.jump2AppPage(!1,e,u):r.jump2H5Page(!1,e,u)};r.handlePay(e,h,c,function(){n.hideLoading(),n.showToast("网络不给力,请稍候重试")})}var n=this,r=T,s=g.get()||{};if(!s){n.showToast("提交失败！请稍后再试");return}var u=s.dsettings,l=_.find(u,function(e){return e.type==2});if(l&&l.value&&l.value.trim().length>0){var c=new e.ui.Layer({onCreate:function(){var e=l.value||"";e=e.replace(/\u000a/img,"<br />"),this.contentDom.html('<div class="cui-pop-box"><div class="cui-hd">现金支付<div class="cui-grayload-close" ></div></div><div class="cui-bd"><div class="p10"><h3>注意事项</h3>'+e+'<button class="paybtn w100" id="cashPayBtn">确认使用现金支付</button></div></div>');var t=this.contentDom.find(".cui-grayload-close");t.click(function(){c.remove()});var n=this.contentDom.find("#cashPayBtn");n.click(function(){console.log("使用现金支付"),c.remove(),o()})},onShow:function(){},onHide:function(){}});c.show()}else try{var h=new e.ui.Alert({title:"",message:u[0].value,buttons:[{text:"取消",click:function(){console.log("取消"),this.hide()}},{text:"确定",click:function(){console.log("确定"),this.hide(),o()},type:e.ui.Alert.STYLE_CONFIRM}]});h.show(),n.alertArr.push(h)}catch(t){var h=new e.ui.Alert({title:"提示信息",message:"系统异常，请重新提交订单(700)",buttons:[{text:"确定",click:function(){var e=a.getAttr("from");i.isInApp()?Business.jump2App(e):window.location.href=e},type:e.ui.Alert.STYLE_CONFIRM}]});h.show(),self.alertArr.push(h);try{var p=a.get();Business.exceptionInfoCollect({bustype:p.bustype,excode:3,extype:1,exdesc:"现金支付服务下发错误ErrorCode:700_token:"+JSON.stringify(p)+",目前现金支付服务下发的报文为："+JSON.stringify(item)})}catch(t){}}},toAlipayBefore:function(){var t=this,n=T;h.setAttr("is_wap",null);var r=d.get()||{},s=r.rusetype||1;f.setAttr("serverPayEntry",s);if(s==2){var o=new e.ui.Alert({title:"",message:"担保金额将预先扣除，订单成交后3个工作日内返还至您的担保账户。",buttons:[{text:"取消",click:function(){this.hide()}},{text:"确定",click:function(){this.hide(),c.setAttr("requestid",a.getAttr("requestid")),h.setAttr("jump_ali",1),i.isInApp()||(window.onpageshow=function(){n.jumpDetailFn.call(t)}),n.jumpToAlipay.call(t)},type:e.ui.Alert.STYLE_CONFIRM}]});o.show(),t.alertArr.push(o)}else c.setAttr("requestid",a.getAttr("requestid")),h.setAttr("jump_ali",1),i.isInApp()||(window.onpageshow=function(){n.jumpDetailFn.call(t)}),n.jumpToAlipay.call(t)},JianhangAppPay:function(t){o.stopEvent(t);var n=this;if(a&&a.get()){n.showLoading();var r=T.getRequestHeader();r=JSON.stringify(r);var i=function(){n.hideLoading(),n.showToast("网络不给力,请稍后再试试吧")},s=a.get()||{},u=decodeURIComponent(s.sback),l=function(t){console.log(t),n.hideLoading();if(t!=null&&t.rc===0){T.setTempOid(t),t.bilno&&a.setAttr("bilno",t.bilno);var r=f.getAttr("osType");r==1?(window.MBC_PAYINFO=function(){return"{"+t.thirdpartyinfo.sig+"}"},window.location="/mbcpay.b2c"):r==2&&window.mbcpay.b2c(t.thirdpartyinfo.sig)}else if(t.rc===4){var i=new e.ui.Alert({title:"提示信息",message:t.rmsg||"网络不给力,请稍候重试",buttons:[{text:"好的",click:function(){T.jump2H5Page(!0,t,u)},type:e.ui.Alert.STYLE_CONFIRM}]});i.show(),n.alertArr.push(i)}else n.showToast("网络不给力,请稍后再试试吧")},c={opttype:1,paytype:4,thirdpartyinfo:{paymentwayid:"EB_CCB",typeid:0,subtypeid:0,typecode:0,amount:a.getAttr("amount")}};T.handlePay(c,l,r,i)}else n.showToast("网络不给力,请稍后再试试吧")},handlePay:function(e,t,n,r){s.pay(e,t,n,r,r)}};return T.getRequestHeader=function(){var e=E.get()||{},t="09",n="1.0";if(i.isInApp()){var r=JSON.parse(localStorage.CINFO);t=r.systemCode,n="601"}var s=a.getAttr("auth")||w.getAttr("auth")||"";return $.extend(e,{cid:"63528842641978287800",syscode:t,cver:n,auth:s}),i.isInApp()&&(e.cid=localStorage.GUID||"63528842641978287800"),e},T.goHome=function(){var e=this,t=a.getAttr("indexurl");setTimeout(function(){e.back(t)},0)},T.removePayCardStore=function(){u.resetParam()},T.setTempOid=function(e){e&&e.oidex&&e["oidex"]!=0&&(l.setAttr("requestid",a.getAttr("requestid")),l.setAttr("realoid",e.oidex))},T.isPreAuth=function(){var e=!1,t=f&&f.get();return t&&t.IsNeedPreAuth&&(e=!0),e},T.exceptionInfoCollect=function(e){e=$.extend({bustype:"",excode:"",extype:1,exdesc:""},e||{});var t=T.getRequestHeader(),n=function(){};s.exceptionInfoCollect(e,function(){},JSON.stringify(t),n,n)},T.getPayMeth=function(){var e=1,t=d.get();return t&&(t.rusetype&4?e=1:t.rusetype&2&&(e=2)),e},T.isAfterCurDate=function(e){var t=!0;if(!e)return t;var n=b.parse(e).format("m"),r=b.parse(e).format("Y"),i=new Date,s=i.getMonth()+1,o=i.getFullYear()?i.getFullYear():2014;return s+1>12?(s=1,o+=1):s+=1,r<o?t=!1:r==o&&n<s&&(t=!1),t},T.isBeforeGuranteeDay=function(e){var t=f,n=!1,r=t.getAttr("lastGuranteeDay");if(!r)return!0;var i=b.parse(""+r).format("Ym"),s=i?parseInt(i):0,o=b.parse(e).format("m"),u=b.parse(e).format("Y"),a=u+o;return a>=s&&(n=!0),n},T.getRiskCtrl=function(){var e=0;return f&&f.get()&&(e=f.get().IsNeedCardRisk?1:0),e},T.unionPayCollection=function(e){function J(e){var t={},n=0,r=e.length,i=null;for(;n<r;n++){i=e[n];if(i.type==5||i.type==6)t[i.type]=i.value||""}return t}var t=T,n=this,r=d.get()||{},s=f&&f.get()||{},u=s.useEType,l=0,p="",v=0,m=0,g=0,y=0;payTypeListJifen=0;var b=r.cards||[],w=r.paytype||[],E=a.getAttr("CashInfo"),x=r.thirdpartylist,N=s.osType,C=[],k=0,L=0,A="",O=0,M="支付",D=n.getViewHash();w&&(w&2&&(v=1),w&4&&(m=1),w&8&&(g=1),w&16&&(y=1)),i.isInApp()&&r.paytype&&r.paytype&64&&(payTypeListJifen=1);if(v){for(var P=0,H=b.length;P<H;P++){var B=b[P];B.status&!0&&C.push(B),B.category==3?k=1:L=1}C.length>0&&(A="新增"),u==2&&(M="担保"),t.isSameCards()&&(n.els.c_payment_paymentnote.show(),l=2,g&&(l=1,p='<li id="c_payment_global_bankcard"><i class="pay_2"></i><div class="valign">'+A+"储蓄卡"+M+"</div></li>"),A+=b[0].typename)}var j=$("#c_payment_global_creditcard"),F=$("#c_payment_global_bankcard"),I=$("#c_payment_global_wechatscan"),q=$("#c_payment_global_mobileali"),R=$("#c_payment_global_cashpay"),U=$("#c_payment_global_jianhangapp"),z=$("#c_payment_global_jifen"),W=['<li id="c_payment_global_wechatscan"><i class="pay_3"></i><div class="valign">微信'+M+"</div></li>",'<li id="c_payment_global_creditcard"><i class="pay_1"></i><div class="valign">'+A+"信用卡"+M+"</div></li>",'<li id="c_payment_global_bankcard"><i class="pay_2"></i><div class="valign">'+A+"储蓄卡"+M+"</div></li>",'<li id="c_payment_global_mobileali"><i class="pay_4"></i><div class="valign">支付宝'+M+'<p class="cgray">支持各大银行信用卡和储蓄卡</p></div></li>','<li id="c_payment_global_cashpay"><i class="pay_5"></i><div class="valign">现金'+M+"</div></li>",'<li id="c_payment_global_jianhangapp"><i class="pay_6"></i><div class="valign">建行APP支付</div></li>','<li id="c_payment_global_jifen"><i class="pay_7"></i><div class="valign">积分担保</div></li>'],X=[];l===1?(W[1]=W[1].replace(M,""),W[2]=p,p=null):l===2&&(W[1]=W[1].replace(M,""),W[2]=W[2].replace(M,"")),I.length>0&&X.push(I),j.length>0&&X.push(j),F.length>0&&X.push(F),q.length>0&&X.push(q),R.length>0&&X.push(R),U.length>0&&X.push(U),z.length>0&&X.push(z);if(X.length>0){var V=X[0].parent();e.html(V.html()),V.html("");return}L&&(X[1]=1);if(k||g)X[2]=2;if(x&&x.length>0&&m){var K=J(r.dsettings),Q=!_.isEmpty(K)&&K[5]&&K[6];Q&&(K[5]=_.escape(K[5].substring(0,6)),K[6]=_.escape(K[6].substring(0,12)),W[0]=W[0].replace("微信"+M,"微信"+M+' <em class="payicon_tips c_payment_index_weixin_title">'+K[5]+'</em><p class="corange c_payment_index_weixin_content">'+K[6]+"</p>"));for(var P=0,G=x.length;P<G;P++){var Y=x[P].paymentwayid;if(i.isInApp()){if(Y=="WechatScanCode"){var Z=o.getSystemVer();Z.platform==3?S.pay.checkStatus({callback:function(e){e.weixinPay&&(X[0]=0)}}):X[0]=0}else if(Y=="OGP_Alipay"||Y=="EB_MobileAlipay")X[3]=3}else if(N){if(Y=="EB_CCB"){X[5]=5;break}}else if(Y=="WechatScanCode")o.isInWeichat()&&(X[0]=0);else if(Y=="OGP_Alipay"||Y=="EB_MobileAlipay")X[3]=3}N||X.splice(5,1)}else w&8&&O==0&&C.length<1&&(X[3]=3),X.splice(0,1);y&&E&&(X[4]=4),payTypeListJifen&&(X[6]=6);if(X.length<1){e.hide();return}var et="",tt="";X.sort(function(e,t){return e-t});for(var P=0,nt=X.length;P<nt;P++)tt=W[X[P]],tt&&(et+=tt);e.html(et),et=null,tt=null;var rt=$("div#main");rt.on("click","#c_payment_global_creditcard",function(e){o.stopEvent(e);var t=n.getViewHash(),r=s.subPayType,i=s.isPayRestrict;!r&&!i?n.forward("cardbin?from="+t):n.forward("selectbank?from="+t)}),rt.on("click","#c_payment_global_bankcard",function(e){o.stopEvent(e);var t=n.getViewHash();i.isInApp()&&c.setAttr("requestid",""),n.forward("selectdpstcard?from="+t)}),rt.on("click","#c_payment_global_wechatscan",function(e){o.stopEvent(e),t.showPromptMask.call(n,2,function(){var e=this;c.setAttr("requestid",a.getAttr("requestid")),h.setAttr("jump_ali",1),i.isInApp()||(window.onpageshow=function(){T.jumpDetailFn.call(e)}),T.jumpToWeiXinpay.call(e)})}),rt.on("click","#c_payment_global_mobileali",function(e){o.stopEvent(e),t.showPromptMask.call(n,1,function(){T.toAlipayBefore.call(this)})}),rt.on("click","#c_payment_global_cashpay",function(e){o.stopEvent(e),t.toCashPayFn.call(n)}),rt.on("click","#c_payment_global_jianhangapp",function(e){o.stopEvent(e),t.JianhangAppPay.call(n,e)}),rt.on("click","#c_payment_global_jifen",function(e){e.preventDefault(),e.stopPropagation(),t.toJiFenPay.call(n,e)});return},T.jumpDetailFn=function(){if(T.isThirdPayBack()){c.setAttr("requestid","");if(!i.isInApp()){var e=a.getAttr("rback");e?window.location.href=e:(T.removePayCardStore(),T.goHome.call(this))}}},T.isThirdPayBack=function(){var e=a.get()||{},t=c.getAttr("requestid");return t&&t==e.requestid?!0:!1},T.VerifyPhone=function(e){this.forward("verifyphone?from="+e)},T.CheckPhoneNum=function(e){var t=this,n=a.get()||{},r={opbitmap:1,bustype:n.bustype,oid:n.oid,requestid:n.requestid};if(d.getAttr("verifiedPhone"))return e(!1);var o=function(n){if(i.isInApp()){if(!n.resultBody){t.hideLoading(),t.showToast(n.errorInformation||"网络不给力,请稍候重试");return}n=JSON.parse(n.resultBody)}if(typeof n.res!="undefined"&&n.res){t.hideLoading(),t.showToast("网络不给力,请稍候重试");return}t.hideLoading();if(n.result==0){if(n.accountinfo&&n.accountinfo.phone)return e(n.accountinfo.phone)}else t.hideLoading(),t.showToast(n.resultmesg||"网络不给力,请稍候重试")};t.showLoading();var u=T.getRequestHeader(),f=JSON.stringify(u);s.getPhoneNum(r,o,f,function(){t.hideLoading(),t.showToast("网络不给力,请稍候重试")})},T.PostCheck=function(e,t,n,r,i,s,o,u){var a=this;T.CheckPhoneNum.call(this,function(f){f?(d.setAttr("verifyMobile",f),d.setAttr("isGetPassWordfrom1501",1),d.setAttr("seniortype",1),T.VerifyPhone.call(a,"index")):(d.setAttr("isGetPassWordfrom1501",0),e?T.AppPay.call(a,t,n,r,i,s,o,u):T.H5Pay.call(a,t,n,r))})},T.supportDecimalBu=function(){var e=[4,3001,14,11,141,2002,5001];return e},T.isSameCards=function(){var e=d.get()||{},t=e.cards||[],n=t.length,r=1;if(n<1)return 0;for(var i=0;i<n;i++)if(t[i].paymentwayid!=t[0].paymentwayid){r=0;break}return r},T.showPromptMask=function(t,n){var r=this,i=u.get()||{},s=i.paymentdetail?i.paymentdetail:null;if(i&&i.orderid!=-1&&s&&s.cardamount+s.qbamount>0){var a=s.cardamount+s.qbamount,f="",l="",c="";t==1?(f="支付宝支付",l="确认使用支付宝支付"):t==2?(f="微信支付",l="确认使用微信支付"):(f="储蓄卡支付",l="确认支付");var h=d.getAttr("dsettings"),p="",v="";for(var m=0;m<h.length;m++)h[m].type==11&&(p=h[m].value||""),h[m].type==12&&(v=h[m].value||"");a=o.transNumToFixedArray(a,2).join("."),p=p.replace(/\{0\}/ig,"<i class='corange'>￥<span class='ft18'>"+a+"</span></i>"),c=p+"<br/>"+"<span class='cgray'>"+v+"</span>";var g=new e.ui.Layer({onCreate:function(){this.contentDom.html('<div class="cui-pop-box"><div class="cui-hd">'+f+'<div id="mb_grayload_close" class="cui-grayload-close" ></div></div>'+'<div class="cui-bd"><div class="p10">'+c+'</div><button class="paybtn w100" id="mbPayBtn">'+l+"</button></div>");var e=this.contentDom.find("#mb_grayload_close");e.click(function(){g.remove()});var t=this.contentDom.find("#mbPayBtn");t.click(function(){g.remove(),n.call(r)})},onShow:function(){},onHide:function(){}});g.show()}else n.call(r)},T})