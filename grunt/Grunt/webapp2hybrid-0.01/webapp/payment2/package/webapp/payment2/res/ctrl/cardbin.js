define(["libs","c","CommonStore","PayStore","PayModel","PayParentView","cardbin_html","cUtility","cWidgetFactory","paymentPipe","cUIInputClear","cUtilityCrypt","cUICore","Business","Util","bankincrement"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v){var m=!1,g=r.PayMentOtherInfo.getInstance(),y=i.PaymentWayModel.getInstance(),b=i.PayMentModel.getInstance(),w=r.PaymentWayStore.getInstance(),E=r.OrderDetailStore.getInstance(),S=r.ExtendInfoStore.getInstance(),x=r.SelectBankStore.getInstance(),T=a.create("Guider"),N=n.HeadStore.getInstance(),C=r.ToAliFlagStore.getInstance(),k=r.Ali_ReStore.getInstance(),L=r.BankListStore.getInstance(),A="",O=S.getAttr("osType"),M=s.extend({pageid:"232003",hpageid:"232003",noticeFlag:"pay",alertArr:[],tpl:o,refidCode:"",payMethFlag:1,onHide:function(){this.hideLoading(),this.hideWarning404(),this.alertArr.forEach(function(e,t){e&&e.hide&&e.hide()}),p&&p.alertArr.forEach(function(e,t){e&&e.hide&&e.hide()})},onCreate:function(){this.render()},onShow:function(){this.setTitle("新增银行卡")},onLoad:function(e){var t=this;p.jumpDetailFn.call(t),t.filterOverSeaCard()&&t.els.c_payment_cardDesc.show(),t.els.c_payment_cardbin.val(""),t.els.c_payment_clear.hide(),t.updatePage();var n=d.getSystemVer();n.platform==4&&t.els.c_payment_cardbin.focus()},render:function(){this.$el.html(this.tpl),this.els={c_payment_cardbin:this.$el.find("#c_payment_cardbin"),clearBankNum:this.$el.find("#clearBankNum"),clearIconBtn:this.$el.find("#clearIconBtn"),c_payment_cardbin_button:this.$el.find("#c_payment_cardbin_button"),c_payment_cardDesc:this.$el.find("#c_payment_cardDesc"),c_payment_clear:this.$el.find("#c_payment_clear")}},goBack:function(){var e=this,t=E.getAttr("indexurl"),n=d.geturlQuery("from");n&&n!="index"?e.back(n):e.back(t)},events:{"input #c_payment_cardbin":"showClearBtn","click #c_payment_cardbin_button":"toBank","click #c_payment_clear":"clearInput","blur #c_payment_cardbin":"cutByFourNum","focus #c_payment_cardbin":"resetMaxLength"},updatePage:function(){var e=this,t={};t.title="新增银行卡",e.initHeadView(t);try{e.turning()}catch(n){}},initHeadView:function(e){var t=this;this.headerview.set({title:e.title,back:!0,view:t,events:{returnHandler:t.goBack}}),this.headerview.show()},showClearBtn:function(e){var t=$(e.target);t.val()?this.els.c_payment_clear.show():this.els.c_payment_clear.hide(),t.val().length>16?t.css("font-size","14px"):t.css("font-size","")},toBank:function(){var e=this,n=E.get()||{},r=S.get()||{},i=r.useEType,s={cardno:e.els.c_payment_cardbin&&e.els.c_payment_cardbin.val().replace(/\s/g,""),bustype:n.bustype,oid:n.oid,usetype:i?i:1,subusetype:p.isPreAuth()?1:0};if(s.cardno.trim().length<1){e.showToast("请输入信用卡号码");var o=d.getSystemVer();o.platform==4&&e.els.c_payment_cardbin.focus();return}var a=function(n){n=n||{};if(u.isInApp()){if(!n.resultBody){e.hideLoading(),e.showToast(n.errorInformation||"网络不给力,请稍候重试");return}n=JSON.parse(n.resultBody)}if(typeof n.res!="undefined"&&n.res){e.hideLoading(),e.showToast("网络不给力,请稍候重试");return}var r=0;e.hideLoading();if(n.rc==0){var i=E.getAttr("indexurl");for(var s=0;s<n.cardinfolist.length;s++){var o=n.cardinfolist[s],a=w.get()||{},f=_.find(a.cards,function(e){return e.typeid==o.typeid});if(f){f.cardnum=e.els.c_payment_cardbin.val(),f.isnewcard=!0,x.set(f),w.setAttr("finalPayWay",-1);if(o.cardtype&1&&f){r=1,e.back(i);return}if(o.cardtype&2&&f){r=1,e.back(i);return}if(o.cardtype&4&&f){r=1,e.back(i);return}}}if(w.getAttr("paytype")&8){L&&L.get&&!L.get()&&v.intBankCrement();try{var l=L.get().origindatas||[];for(var s=0;s<n.cardinfolist.length;s++){var c,o=n.cardinfolist[s];if(o.cardtype&8)for(var h=0;h<l.length;h++){var c=_.find(l[h].subDatas||[],function(e){return e.itembCode==o.bankcode});if(c){p.showPromptMask.call(e,3,function(){r=1,k.setAttr("requestid",E.getAttr("requestid")),C.setAttr("jump_ali",1),C.setAttr("is_wap",1),C.setAttr("bankcode",o.bankcode),u.isInApp()||(window.onpageshow=function(){p.jumpDetailFn.call(e)}),C.setAttr("thirdcardnum",e.els.c_payment_cardbin.val().replace(/\s/g,"")),_.bind(p.jumpToAlipay,e)()});return}}}}catch(d){L.remove();var m=new t.ui.Alert({title:"提示信息",message:"系统异常，请重新提交订单(502)",buttons:[{text:"确定",click:function(){var e=E.getAttr("from");u.isInApp()?p.jump2App(e):window.location.href=e},type:t.ui.Alert.STYLE_CONFIRM}]});m.show(),e.alertArr.push(m);try{var g=E.get();p.exceptionInfoCollect({bustype:g.bustype,excode:3,extype:1,exdesc:"银行增量数据ErrorCode:502_token:"+JSON.stringify(g)})}catch(d){}}}if(!r){var y=(_.find(n.msglist,function(e){return Number(e.type)==2})||{}).value||"抱歉，该卡暂未支持，请尝试更换其他银行卡";e.showToast(y)}}else{var y=(_.find(n.msglist,function(e){return Number(e.type)==n.rc})||{}).value||"抱歉，该卡暂未支持，请尝试更换其他银行卡";e.showToast(y)}},o=d.getSystemVer();o.platform==4&&e.els.c_payment_cardbin.focus(),e.showLoading();var l=p.getRequestHeader(),c=JSON.stringify(l);f.verifyCardBin(s,a,c,function(){e.hideLoading(),e.showToast("网络不给力,请稍候重试")})},filterOverSeaCard:function(){var e=w.getAttr("cards");for(var t=0;t<e.length;t++)if(e[t].status&2)return 1;return 0},clearInput:function(){this.els.c_payment_clear.hide(),this.els.c_payment_cardbin.val("").focus()},filterAliCard:function(e){var t=L.get()&&L.get().origindatas,n="";for(var r=0;r<t.length;r++){n=_.find(t[r].subDatas,function(t){return t.itembCode==e.bankcode});if(n)return 1}return 0},cutByFourNum:function(e){var t=e.target.value,n=[];/\D/gi.test(t)?(n=t.match(/\d/g),n&&n.length>0?setTimeout(function(){e.target.value="",e.target.value=n.join("").replace(/\s/g,"").replace(/(\d{4})(?=\d)/g,"$1 ")},60):(e.target.value="",this.hideDelIcon())):e.target.value=t.replace(/\s/g,"").replace(/(\d{4})(?=\d)/g,"$1 ")},resetMaxLength:function(e){e.target.value=e.target.value.replace(/\s/g,"")},hideDelIcon:function(){this.els.c_payment_clear.hide()}});return M})