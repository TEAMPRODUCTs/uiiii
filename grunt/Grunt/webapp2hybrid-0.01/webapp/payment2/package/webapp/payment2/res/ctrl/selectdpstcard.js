define(["libs","c","CommonStore","PayModel","PayStore","PayParentView","paymentPipe","selectdpstcard_html","cUtility","cWidgetFactory","Business","Util","bankincrement"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){var p="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),d=i.SelectBankStore.getInstance(),v=i.PaymentWayStore.getInstance(),m=i.OrderDetailStore.getInstance(),g=i.Ali_ReStore.getInstance(),y=i.ToAliFlagStore.getInstance(),b=i.BankListStore.getInstance(),w=i.ISDiffSelectBankStore.getInstance(),E=i.ExtendInfoStore.getInstance(),S=f.create("Guider"),x=n.HeadStore.getInstance(),T=s.extend({tpl:u,Business:l,alertArr:[],pagetype:null,pageid:"232005",hpageid:"232005",render:function(){this.$el.html(this.tpl),this.els={citybox:this.$el.find(".city_box"),citylisttpl:this.$el.find("#citylisttpl"),keyword:this.$el.find("#keyword"),currentcity:this.$el.find(".currentcity"),elassociate:this.$el.find(".associate"),cancelSearchBtn:this.$el.find("#cancel_searchBtn"),paymentnote:this.$el.find("#paymentnote")},this.templateCityList=_.template(this.els.citylisttpl.html()),t.ui.InputClear(this.els.keyword)},events:{"click #js_return":"goBack","click #city_list":"selCity","click .city_box .grouptitle":"GroupTitleClick","click .cityitem":"TapCityItemAction","click #curcity":"curcityOnClick","input #keyword":"keywordOnInput","blur #keyword":"keywordOnBlur","focus #keyword":"keywordOnFocus","click .history_close":"clearKeyword","click .c-payment-spc-cl dt":"toggleListFn","click #cancel_searchBtn":"cancelSearchFn"},cancelSearchFn:function(e){var t=$(e.target);console.log("cancel search"),this.els.keyword.val(""),this.els.citybox.show(),this.els.elassociate.hide(),this.els.elassociate.empty(),t.hasClass("none")||t.addClass("none")},getUrlParama:function(){var e="";return m.get()&&(e=m.getAttr("indexurl")),e},goBack:function(){var e=this,t=this.getUrlParama(),n=c.geturlQuery("from");n&&n!="index"?e.back("#"+n):e.back(t)},toggleListFn:function(e){var t=$(e.currentTarget),n=t.attr("data-class");n&&($("."+n).toggleClass("none"),$("."+n).hasClass("none")?t.find("i").removeClass("arr_down arr_up").addClass("arr_up"):t.find("i").removeClass("arr_down arr_up").addClass("arr_down"))},curcityOnClick:function(e){var t=$(e.currentTarget),n=t.attr("data-city"),r=t.attr("data-cityid");t.hasClass("ispos")&&n&&r&&(this.searchParam.setAttr({dCtyName:n,dCtyId:r}),this.goBack())},clearKeyword:function(){this.els.keyword.val(""),this.els.keyword.trigger("input")},keywordOnInput:function(e){var t=$(e.currentTarget),n=t.val().toLowerCase(),r=this.els.citybox.find('[data-filter*="'+n+'"]'),i,s={};if(n.length){this.els.citybox.hide(),this.els.elassociate.hide(),this.els.elassociate.empty();var r=$.grep(r,function(e){var t=$(e),r=$.trim(t.attr("data-filter")).split(" ");for(var i=0;i<r.length;i++)if(r[i].indexOf(n)===0)return!0;return!1});_.each(r,$.proxy(function(e,t){var n=$(e.cloneNode(!0));s[n.attr("data-id")]||(n.removeClass("none"),this.els.elassociate.append(n)),s[n.attr("data-id")]=!0},this)),r.length||this.els.elassociate.html('<dd class="hm">没有结果</dd>'),this.els.elassociate.show()}else this.els.citybox.show(),this.els.elassociate.hide()},keywordOnBlur:function(){},keywordOnFocus:function(){this.els.cancelSearchBtn.removeClass("none")},TapCityItemAction:function(e){var t=$(e.currentTarget),n=this.Business,r=this,i=t.attr("data-ali"),s=t.attr("data-name"),o=t.attr("data-id");y.setAttr("thirdcardnum","");var u=_.find(this.filtePaymentType(),function(e){return e.typeid==o});this.setIsDiffFn(u,d.get()),u&&(u.isnewcard=!0,u.cardnum="",d.set(u),v.setAttr("finalPayWay",-1));if(i=="ALI")n.showPromptMask.call(r,3,function(){g.setAttr("requestid",m.getAttr("requestid")),y.setAttr("jump_ali",1),y.setAttr("is_wap",1),y.setAttr("bankcode",t.attr("data-id")),a.isInApp()||(window.onpageshow=function(){n.jumpDetailFn.call(r)}),_.bind(n.jumpToAlipay,r)()});else if(u.category==3){var f=m.getAttr("indexurl");this.back(f)}},setIsDiffFn:function(e,t){var n=1;e&&t&&(e.typeid==t.typeid?n=2:n=1),w.set({isDiff:n})},GroupTitleClick:function(e){var t=$(e.currentTarget),n=t.next(".clist");n.css("display")==="none"?(this.$el.find(".clist").hide(),n.show(),this.scrollToEl(t[0],{left:0,top:-60})):n.hide()},scrollToEl:function(e,n){var r=t.ui.Tools.getElementPos(e);n=n||{left:0,top:0},window.scrollTo(r.left+n.left,r.top+n.top)},updatePage:function(e){this.showLoading(),b&&b.get&&!b.get()&&h.intBankCrement(),this.banklistData=b.get(),this.randerList(this.banklistData),e&&e.call(this)},randerList:function(e){var n=this;try{var r={keycode:p,list:e.list,hots:e.hots,paymentList:this.filtePaymentType(),curCityId:d.get()?d.get().typeid:0,curCityName:""}}catch(i){b.remove();var s=new t.ui.Alert({title:"提示信息",message:"系统异常，请重新提交订单(504)",buttons:[{text:"确定",click:function(){var e=m.getAttr("from");a.isInApp()?l.jump2App(e):window.location.href=e},type:t.ui.Alert.STYLE_CONFIRM}]});s.show(),n.alertArr.push(s);try{var o=m.get();l.exceptionInfoCollect({bustype:o.bustype,excode:3,extype:1,exdesc:"银行增量数据ErrorCode:504_token:"+JSON.stringify(o)})}catch(i){}}window.viewdata=r;var u=this.templateCityList(r);this.els.citybox.html(u),console.log($(".js_hidden_initial")),this.els.citybox.find(".js_hidden_initial").prev("dt").hide();if(!(m.getAttr("paytype")&8)){this.els.citybox.find("dd").hide(),this.els.citybox.find("dt").hide();for(var f=0;f<r.paymentList.length;f++){var c=this.els.citybox.find("dd");for(var h=0;h<c.length;h++)c[h].getAttribute("data-id")==r.paymentList[f]["typeid"]&&($(c[h]).show(),this.els.citybox.find("dt[data-class="+c[h].className.split(" ")[0]+"]").show())}}},filtePaymentType:function(){var e=[];if(v.get())return e=_.filter(v.get().cards,function(e){return(e.status!=2||e.status!=3)&&e.category==3}),e;var t=m.get().indexurl;this.back(t.substring(1))},detectIsInBankList:function(e,t,n){var r=null,i=_.find(e.subDatas,function(e){return e.itemName=="DC"}),s=_.find(e.subDatas,function(e){return e.itemName=="ALI"}),o=null,u=e.subDatas||[],a=this.getBankIds(t);return i?a[i.itembCode]?r=a[i.itembCode]:s&&(s.itembCode=="0"?r=null:r=s):r=null,r},getBankIds:function(e){var t={};return _.each(e,function(e){t[e.typeid]=e}),t},showAfter:function(){this.els.elcurcity=this.els.citybox.find("#curcity")},onCreate:function(){l.jumpDetailFn.call(this),this.render(),this.showLoading()},selectCurrentCity:function(){var e=this.els.citybox.find(".citylistcrt");if(e.length>1||e.length<1)this.els.citybox.find(".hotcitys .clist").css("display","block");else{e.parent().css("display","block");var t=e.parent().parent()[0];this.scrollToEl(t,{left:0,top:-60})}},onLoad:function(){var e=this;e.headerview.set({title:"选择储蓄卡银行",back:!0,home:!1,view:e,events:{returnHandler:$.proxy(function(){$("#keyword").val(""),this.goBack()},this),homeHandler:$.proxy(function(){this.jump("/html5/")},this)}});var t=this.getQuery("from");t&&t.length>0&&(t=decodeURIComponent(t),this.urlFrom=t.substr(t.indexOf("#")+1)),this.headerview.show(),this.showLoading(),this.updatePage(function(){this.hideLoading();try{e.turning()}catch(t){}E.getAttr("isPayRestrict")&&(this.pageid=232007,this.hpageid=232007,this.els.paymentnote.show(),this.els.citybox.find("dt").remove(),this.$el.find(".js_search_box").remove(),this.els.citybox.find(".js_hot").remove())})},onShow:function(){this.showAfter()},onHide:function(){this.els.citybox.show(),this.els.elassociate.hide(),l&&l.alertArr.forEach(function(e,t){e&&e.hide&&e.hide()})},selCity:function(){}});return T})