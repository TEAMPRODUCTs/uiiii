define(["c","cWidgetFactory","PayModel","PayStore","CommonStore","cUtility","Util","Business","cUtilityCrypt","PayStore"],function(e,t,n,r,i,s,o,u,a,r){var f={},l=r.ParamUrlTokenStore.getInstance(),c=r.OrderDetailStore.getInstance(),h=r.ExtendInfoStore.getInstance(),p=r.PayMentOtherInfo.getInstance(),d=r.tktErrorStore.getInstance(),v=r.PayMentCardParamStore.getInstance(),m=r.lipinCardEInfo.getInstance();f.getOrderDetail=function(){var t=this,n,r=Lizard.P("token")||"";r=decodeURIComponent(r);var i,o={},h=!1;try{i=a.Base64.decode(r),i.length>0&&(n=JSON.parse(i)),$.each(n,function(e,t){t&&_.isString(t)&&(t=$.trim(t)),o[e]=t}),typeof o.currency=="undefined"&&(o.currency="CNY"),typeof o.displayCurrency=="undefined"&&(o.displayCurrency=""),typeof o.displayAmount=="undefined"&&(o.displayAmount=""),typeof o.recall=="undefined"&&(o.recall=""),typeof o.extno=="undefined"&&(o.extno=""),typeof o.needInvoice=="undefined"&&(o.needInvoice=!1),typeof o.invoiceDeliveryFee=="undefined"&&(o.invoiceDeliveryFee=0),typeof o.includeInTotalPrice=="undefined"&&(o.includeInTotalPrice=!1),o.indexurl=t.getViewUrl(),o.indexUrl=location.href,o.totalamount=o.amount,o.origamount=o.amount}catch(g){u.exceptionInfoCollect({bustype:o.bustype||"",excode:3,extype:1,exdesc:"Bu传递url解析异常"+g+"BU传过来的token参数："+r}),console.warn("Bu传递url解析异常"+g);var y="系统异常，请重新提交订单！！！",b=new e.ui.Alert({title:"提示信息",message:y,buttons:[{text:"确定",click:function(){this.hide(),window.history.back()},type:e.ui.Alert.STYLE_CONFIRM}]});b.show(),h=!0;return}if(h)return;l.set(o);if(!o.oid||!o.bustype||!o.sback||!o.title||!o.amount){t.hideLoading();var y="系统异常，请重新提交订单！！";!_.isUndefined(o.amount)&&o.amount==0&&(y="系统异常，请重新提交订单！");var b=new e.ui.Alert({title:"提示信息",message:y,buttons:[{text:"确定",click:function(){this.hide(),t.goBack(o.from)},type:e.ui.Alert.STYLE_CONFIRM}]});b.show();try{u.exceptionInfoCollect({bustype:o.bustype||"",excode:3,extype:1,exdesc:msgArr.join(",")+",BU传过来的参数："+JSON.stringify(o)})}catch(g){}this.otherInfoFlag=!0;return}o.isload=o.islogin?0:1,c.set(o);if(f.setExtendParams(o))return;if(s.isInApp()){var w=m.getAttr("flag_lipincard");m.setAttr("flag_lipincard",""),!w}else u.jumpDetailFn.call(this);s.isInApp()||setTimeout(function(){c.setAttr("indexurl",t.getViewUrl()),c.setAttr("indexUrl",location.href)},100);var E=p.getAttr("requestid");return E&&E!=o.requestid&&(p.remove(),payMentStore.setAttr("verifiedPhone",null)),d&&d.remove(),v.resetParam(),!0},f.setExtendParams=function(t){var n=this,r={},i=!1;try{var s=decodeURIComponent(Lizard.P("extend")||""),o="";a.Base64.decode(s).length>0?(o=JSON.parse(a.Base64.decode(s)),$.each(o,function(e,t){var n=t;if(n=="null"||n=="undefined")n="";r[e]=n}),console.log(JSON.stringify(r)),h.set(r)):h.set({})}catch(f){u.exceptionInfoCollect({bustype:t.bustype||"",excode:3,extype:1,exdesc:"Bu传递url解析异常"+f+"BU传过来的extend参数："+s}),console.warn("Bu传递url解析异常"+f);var l="系统异常，请重新提交订单！！！",c=new e.ui.Alert({title:"提示信息",message:l,buttons:[{text:"确定",click:function(){this.hide(),window.history.back()},type:e.ui.Alert.STYLE_CONFIRM}]});c.show(),i=!0}return i};var g={};return g.requireTokenParamList={oid:"订单号",bustype:"PD类型",requestid:"支付请求ID",islogin:"是否会员登录",from:"跳转支付前页面的URL",sback:"支付成功跳转URL",eback:"支付错误跳转URL",auth:"登陆后服务端下发的auth",title:"订单信息",amount:"需要支付的金额"},g.addressParamList={from:"跳转支付前页面的URL",rback:"第三方支付返回跳转URL",sback:"支付成功跳转URL",eback:"支付错误跳转URL"},g.requiredParamCheck=function(){if(!g.urlOid)return"订单号不能为空";if(!g.urlBustype)return"PD类型不能为空";if(!g.urlToken)return"token类型不能为空";var e=null,t=JSON.parse(g.urlToken);for(var n in g.requireTokenParamList)if(typeof t[n]=="undefined"||t[n]==null||t[n]===""){e=g.requireTokenParamList[n]+"["+n+"]"+"不能为空###"+JSON.stringify(t);break}return e},g.addressCheck=function(){var e=null,t=JSON.parse(g.urlToken);for(var n in g.addressParamList)if(t[n])if(s.isInApp()){if(!/file:\/\/.*/gi.test(t[n])){e=g.addressParamList[n]+"["+n+"="+t[n]+"]"+"格式错误###"+JSON.stringify(t);break}}else if(!/(http|https):\/\/.*/gi.test(t[n])){e=g.addressParamList[n]+"["+n+"="+t[n]+"]"+"格式错误###"+JSON.stringify(t);break}return e},f.verifyUrl=function(){var e=this,t="",n=o.getEnvironment();if(n=="SC_WEB"||n=="SC_APP")return!0;try{g.urlOid=Lizard.P("oid")||"",g.urlBustype=Lizard.P("bustype")||"";var r=Lizard.P("token")||"";r=decodeURIComponent(r),r=a.Base64.decode(r),g.urlToken=r;var i=Lizard.P("extend")||"";i=decodeURIComponent(i),i=a.Base64.decode(i),g.urlExtend=i}catch(s){var u=window.location.href;return alert("Base64解析Bu传入的url异常"+u),!1}return t=g.requiredParamCheck(),t?(alert(t),!1):(t=g.addressCheck(),t?(alert(t),!1):!0)},f})