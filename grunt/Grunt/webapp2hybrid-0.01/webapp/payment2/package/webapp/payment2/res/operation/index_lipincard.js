define(["c","PayStore","Util"],function(e,t,n){var r=t.PayMentCardParamStore.getInstance(),i=t.OrderDetailStore.getInstance(),s={};return s.setLIPINCard=function(e){var t=s,o=this,u=i.get()||{},a,f={},l=/([0-9]+\.[0-9]{2})[0-9]*/,c=e.walletlist||[],h=e.tktinfo&&e.tktinfo.tkts||[];e.tktinfo&&e.tktinfo.tkts&&(e.tktinfo.tkts=h=t.filterRWZ(h));if(u&&u.displayCurrency&&u.displayAmount){o.els.lipinCard.empty().hide();return}if(t.isAllNoMoney(e)){o.els.lipinCard.empty().hide();return}if(t.isAllUnable(e)){f.type=3,a=o.templateLipinCard(f),o.els.lipinCard.html(a).show();return}if(t.isQbAble(e)){f.type=1,f.laveamount=u.totalamount,f.useamount=0,f.amount=t.getRemain(c)+t.getRemainCard(h),f.amount=f.amount+"",f.amount=parseFloat(f.amount.replace(l,"$1")),r.getAttr("orderid")!==-1&&(r.get().cardInfo&&r.get().cardInfo.laveamount&&(f.laveamount=r.get().cardInfo.laveamount,f.useamount=n.folatcount(u.totalamount,r.get().cardInfo.laveamount,"-"),f.useamount=n.remain2Num(f.useamount)),console.log("继续未完成的支付")),f.useamount>0?f.useamount=f.useamount:f.useamount="去使用",f.laveamount=f.laveamount,a=o.templateLipinCard(f),o.els.lipinCard.html(a).show(),f.useamount>0?(o.$el.find("#order_leaveamount_p").html(t.showStillAmount(parseFloat(f.laveamount))),o.$el.find("#order_leaveamount_p").show()):o.$el.find("#order_leaveamount_p").hide();return}if(e&&e.paytype&&((e.paytype&32)==32||(e.paytype&1)==1)){if(!(c[0].cashbalance>0||!t.isAllTktUnable(e))&&!t.isAllTktNoMoney(h)){f.type=4,a=o.templateLipinCard(f),o.els.lipinCard.html(a).show();return}f.type=2,f.wallertlist=c,f.tkts=h,a=o.templateLipinCard(f),o.els.lipinCard.html(a).show()}else this.els.lipinCard.empty().hide()},s.filterRWZ=function(e){var t=[];for(var n=0;n<e.length;n++)e[n].tkttype<3&&t.push(e[n]);return t},s.isAllNoMoney=function(e){var t=e.walletlist||[];for(var n=0;n<t.length;n++)if(t[n].cashbalance>0)return!1;var r=e.tktinfo&&e.tktinfo.tkts||[];for(var n=0;n<r.length;n++)if(r[n].amount>0)return!1;return!0},s.isAllUnable=function(e){var t=e.walletlist||[];for(var n=0;n<t.length;n++)if(t[n].status==1)return!1;var r=e.tktinfo&&e.tktinfo.tkts||[];for(var n=0;n<r.length;n++)if(r[n].status==0)return!1;return!0},s.isQbAble=function(e){var t=e.walletlist||[];for(var n=0;n<t.length;n++)if(t[n].status==1&&t[n].cashbalance>0)return!0;var r=e.tktinfo&&e.tktinfo.tkts||[];for(var n=0;n<r.length;n++)if(r[n].status==0&&r[n].amount>0)return!0;return!1},s.getRemain=function(e){e=e||[];var t=0;return _.each(e,function(e){e.status==1&&(t+=e.cashbalance*1)}),t},s.getRemainCard=function(e){e=e||[];var t=0;return _.each(e,function(e){e.status==0&&(t+=e.amount*1)}),t},s.showStillAmount=function(e){var t=n.transNumToFixedArray(e),r=i.getAttr("currency")||"￥";r=="CNY"&&(r="￥");var s=new Array;return s.push("还需支付：<i class='corange'>"),s.push(r),s.push("<span class='ft18'>"),s.push(t[0]),s.push("</span>"),t&&t.length>1&&(s.push("."),s.push(t[1])),s.push("</i>"),s.join("")},s.isAllTktUnable=function(e){var t=e.tktinfo&&e.tktinfo.tkts||[];for(var n=0;n<t.length;n++)if(t[n].status<1)return!1;return!0},s.isAllTktNoMoney=function(e){for(var t=0;t<e.length;t++)if(e[t].amount>0)return!1;return!0},s})