define(["c","cWidgetFactory","PayModel","PayStore","CommonStore","cUtility","paymentPipe","RuleManager"],function(e,t,n,r,i,s,o,u){function a(e){this.prefix=e.prefix,this.container=e.container,this.initViewEle=e.initViewEle||null,this.view=e.view,this.module=e.module,this.cacheArr=[],this.policyIds=[],this.rules=null,this.valHash={},this.valiArr=[],this.oriArr=[],this.add=function(e){var t=this;e&&(e instanceof Array?_.each(e,function(e,n){e&&e.policyId&&!t.valHash[e.policyId]&&(t.valiArr.push(e),t.container.append(e.tpl()),t.valHash[e.policyId]=e)}):typeof e=="object"&&ele&&ele.policyId&&!this.valHash[e.policyId]&&(this.valiArr.push(e),this.container.append(e.tpl()),this.valHash[e.policyId]=e))},this.setModule=function(e){this.module=e,this.rules.setModule(e)},this.beforeInit=function(){var t=e,n=this,r=[];t&&t.valiArr&&(t.valiArr?this.oriArr=t.valiArr:this.oriArr=[],r=_.pluck(t.valiArr,"policyId")),this.policyIds=r,this.rules=new u({view:n.view,module:n.module})},this.beforeInit(),this.render=function(e){var t=1;if(e&&typeof e=="number")for(var n=0;n<8;n++)t=Math.pow(2,n),(e&t)>0&&this.switchPolicy(t);this.flush(this.getSortArr()),this.initViewEle&&this.initViewEle()},this.initValiCom=function(e,t){var n=this;console.log("isReRender: "+this.rules.isReRender),!this.rules.isReRender||(this.setOrigin(),this.render(e))},this.setPolicyFn=function(e,t){var n=this;this.valiArr instanceof Array&&this.valiArr.length>0&&_.each(this.valiArr,function(r,i){if(r.policyId==e.policyId)if(t)n.valiArr.splice(i,1,e);else for(var s in e)r[s]=e[s]})},this.validate=function(e){var t=this,n=this.rules;n.setLayerShow(!1),_.each(this.valiArr,function(e,r){e&&e.isVali&&(e.valFn&&typeof e.valFn=="function"?e.valFn({obj:t.container.find("."+e.id),wrapObj:t.container.find("."+e.wrapId),valHash:t.valHash,policyId:e.policyId}):n&&n.valHash[e.policyId]&&_.bind(n.valHash[e.policyId],n)({obj:t.container.find("."+e.id),wrapObj:t.container.find("."+e.wrapId),valHash:t.valHash,policyId:e.policyId}))}),!this.getErrResult()||e&&e()}}return a.prototype.getErrResult=function(){var e=!0,t=1,n=this.container.find(".cui-input-error");return n&&n.each(function(n,r){$(r).hasClass("cui-input-error")&&(e=!1,$(r).find("input").length>0&&(t&&(t=0,$(r).find("input").focus()),$(r).find("input").val("")))}),e},a.prototype.setOrigin=function(){this.container.html(""),this.valHash={},this.valiArr=[],this.cacheArr=[]},a.prototype.getSortArr=function(){var e=[],t=this,n=null;return this.policyIds instanceof Array&&this.policyIds.length>0&&_.each(this.policyIds,function(r,i){n=_.find(t.cacheArr,function(e){return e.policyId==r}),n&&e.push(n)}),e},a.prototype.flush=function(e){e instanceof Array&&e.length>0&&this.add(e)},a.prototype.switchPolicy=function(e){var t=this,n=null;n=_.find(this.oriArr,function(t){return t.policyId==e}),n&&this.cacheArr.push(n)},a})