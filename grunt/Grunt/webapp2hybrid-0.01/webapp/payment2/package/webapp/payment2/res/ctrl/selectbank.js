define(["libs","c","PayModel","PayStore","PayParentView","selectbank_html","cUtility","cWidgetFactory","Business","Util","bankincrement"],function(e,t,n,r,i,s,o,u,a,f,l){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),h=r.SelectBankStore.getInstance(),p=r.PaymentWayStore.getInstance(),d=r.OrderDetailStore.getInstance(),v=r.BankListStore.getInstance(),m=r.CrdtCardDiffStore.getInstance(),g=r.ExtendInfoStore.getInstance(),y=i.extend({tpl:s,pageid:"232004",hpageid:"232004",render:function(){this.$el.html(this.tpl),this.els={xkTitle:this.$el.find("#xkTitle"),ul_tabCheck:this.$el.find("#ul_tabCheck"),li_neicard:this.$el.find("#li_neicard"),li_waicard:this.$el.find("#li_waicard"),neicardList:this.$el.find("#neicardList"),waicardList:this.$el.find("#waicardList"),citybox:this.$el.find(".city_box"),citylisttpl:this.$el.find("#citylisttpl"),keyword:this.$el.find("#keyword"),currentcity:this.$el.find(".currentcity"),elassociate:this.$el.find(".associate"),paymentnote:this.$el.find("#paymentnote")},this.templateCityList=_.template(this.els.citylisttpl.html()),t.ui.InputClear(this.els.keyword)},events:{"click #li_neicard":"turnneicard","click #li_waicard":"turnwaicard","click #js_return":"goBack","click #city_list":"selCity","click .city_box .grouptitle":"GroupTitleClick","click .cityitem":"TapCityItemAction","click #curcity":"curcityOnClick","input #keyword":"keywordOnInput","blur #keyword":"keywordOnBlur","focus #keyword":"keywordOnFocus","click .history_close":"clearKeyword","click .c-payment-selectbank-cl dt":"toggleListFn"},turnneicard:function(){this.pageid=232004,this.hpageid=232004,this.els.li_waicard.removeClass("cui-tab-current"),this.els.li_neicard.addClass("cui-tab-current"),this.els.waicardList.hide(),this.els.neicardList.show()},turnwaicard:function(){this.pageid=232008,this.hpageid=232008,this.els.li_neicard.removeClass("cui-tab-current"),this.els.li_waicard.addClass("cui-tab-current"),this.els.neicardList.hide(),this.els.waicardList.show()},toggleListFn:function(e){var t=$(e.currentTarget),n=t.attr("data-class");n&&($("."+n).toggleClass("none"),$("."+n).hasClass("none")?t.find("i").removeClass("arr_down arr_up").addClass("arr_up"):t.find("i").removeClass("arr_down arr_up").addClass("arr_down"))},curcityOnClick:function(e){var t=$(e.currentTarget),n=t.attr("data-city"),r=t.attr("data-cityid");t.hasClass("ispos")&&n&&r&&(this.searchParam.setAttr({dCtyName:n,dCtyId:r}),this.goBack())},clearKeyword:function(){this.els.keyword.val(""),this.els.keyword.trigger("input")},keywordOnInput:function(e){var t=$(e.currentTarget),n=t.val().toLowerCase(),r=this.els.citybox.find('[data-filter*="'+n+'"]'),i,s={};if(n.length){this.els.citybox.hide(),this.els.elassociate.hide(),this.els.elassociate.empty();var r=$.grep(r,function(e){var t=$(e),r=$.trim(t.attr("data-filter")).split(" ");for(var i=0;i<r.length;i++)if(r[i].indexOf(n)===0)return!0;return!1});_.each(r,$.proxy(function(e,t){var n=$(e.cloneNode(!0));s[n.attr("data-id")]||this.els.elassociate.append(n),s[n.attr("data-id")]=!0},this)),r.length||this.els.elassociate.html('<dd class="hm">没有结果</dd>'),this.els.elassociate.show()}else this.els.citybox.show(),this.els.elassociate.hide()},keywordOnBlur:function(){},keywordOnFocus:function(){},TapCityItemAction:function(e){var t=$(e.currentTarget),n=t.attr("data-name"),r=t.attr("data-id"),i=_.find(this.filtePaymentType(0),function(e){return e.typeid==r});this.setIsDiffFn(i,h.get());if(i){i.isnewcard=!0,i.cardnum="",h.set(i),p.setAttr("finalPayWay",-1);var s=d.getAttr("indexurl");this.back(s)}},setIsDiffFn:function(e,t){var n=1;e&&t&&(e.typeid==t.typeid?n=2:n=1),m.set({isDiff:n})},GroupTitleClick:function(e){var t=$(e.currentTarget),n=t.next(".clist");n.css("display")==="none"?(this.$el.find(".clist").hide(),n.show(),this.scrollToEl(t[0],{left:0,top:-60})):n.hide()},scrollToEl:function(e,n){var r=t.ui.Tools.getElementPos(e);n=n||{left:0,top:0},window.scrollTo(r.left+n.left,r.top+n.top)},updatePage:function(e){this.showLoading(),v&&v.get&&!v.get()&&l.intBankCrement(),this.banklistData=v.get(),this.randerList(this.banklistData),this.renderWkList(),g.getAttr("isPayRestrict")&&(this.els.xkTitle.show(),this.els.citybox.find("dt").remove(),this.$el.find(".js_search_box").remove(),this.els.citybox.find(".js_hot").remove());var t=this.isSupportOne();e&&e.call(this)},isSupportOne:function(){var e=this,t=e.filtePaymentType(2);if(!t||t.length<=0){this.els.ul_tabCheck.hide(),this.els.waicardList.hide(),this.els.neicardList.show();return}var n=e.filtePaymentType(1);if(!n||n.length<=0){this.els.ul_tabCheck.hide(),this.els.neicardList.hide(),this.els.waicardList.show();return}var r=h.get()?h.get().status:0;(r&2)==2&&this.turnwaicard()},renderWkList:function(){var e=this,t=this.filtePaymentType(2);t&&t.length>0&&_.each(t,function(t,n){e.$el.find("#li"+t.typeid).length>0?(e.$el.find("#li"+t.typeid).show(),e.$el.find("#li"+t.typeid).attr("data-id",t.typeid)):(e.$el.find("li[value='"+t.typeid+"']").show(),e.$el.find("li[value='"+t.typeid+"']").attr("data-id",t.typeid))});var n=h.get()?h.get().typeid:0;e.$el.find("#waicardList li").removeClass("ok_crt"),n&&(e.$el.find("#li"+n).addClass("ok_crt"),e.$el.find("li[value='"+n+"']").addClass("ok_crt"))},randerList:function(e){var n=this;try{var r={keycode:c,list:e.list,hots:e.hots,paymentList:this.filtePaymentType(1),curCityId:h.get()?h.get().typeid:0,curCityName:""}}catch(i){v.remove();var s=new t.ui.Alert({title:"提示信息",message:"系统异常，请重新提交订单(505)",buttons:[{text:"确定",click:function(){var e=d.getAttr("from");o.isInApp()?a.jump2App(e):window.location.href=e},type:t.ui.Alert.STYLE_CONFIRM}]});s.show(),n.alertArr.push(s);try{var u=d.get();a.exceptionInfoCollect({bustype:u.bustype,excode:3,extype:1,exdesc:"银行增量数据ErrorCode:503_token:"+JSON.stringify(u)})}catch(i){}}window.viewdata=r;var f=this.templateCityList(r);this.els.citybox.html(f),this.els.citybox.find(".js_hidden_initial").prev("dt").hide(),this.isOnlyDirect=_.find(r.paymentList,function(e){return e.category==2})?!1:!0,this.isOnlyDirect&&(this.els.citybox.find("dt").remove(),this.$el.find(".js_search_box").remove(),this.els.citybox.find(".js_hot").remove())},filtePaymentType:function(e){if(p.get())return e==0?_.filter(p.get().cards,function(e){return e.category!=3}):e==1?_.filter(p.get().cards,function(e){return(e.status&2)!=2&&e.category!=3}):_.filter(p.get().cards,function(e){return(e.status&2)==2});var t=d.get().indexurl;this.back(t)},detectIsInBankList:function(e,t){var n=_.find(e.subDatas,function(e){return e.itemName=="CCD"}),r=_.find(e.subDatas,function(e){return e.itemName=="CCY"}),i=null;return n||r?_.find(t,function(e){return e.typeid==n.itembCode})||_.find(t,function(e){return e.typeid==r.itembCode}):!1},showAfter:function(){this.selectCurrentCity(),this.els.elcurcity=this.els.citybox.find("#curcity")},onCreate:function(){this.render(),this.showLoading()},selectCurrentCity:function(){if(this.searchParam){var e=this.searchParam.getAttr("isselect"),t=this.searchParam.getAttr("dCtyId");e&&this.els.citybox.find('[data-id="'+t+'"]').addClass("citylistcrt");var n=this.els.citybox.find(".citylistcrt");if(n.length>1||n.length<1)this.els.citybox.find(".hotcitys .clist").css("display","block");else{n.parent().css("display","block");var r=n.parent().parent()[0];this.scrollToEl(r,{left:0,top:-60})}}},onLoad:function(){var e=this;e.headerview.set({title:"选择信用卡银行",back:!0,home:!1,view:e,events:{returnHandler:$.proxy(function(){$("#keyword").val(""),this.goBack()},this),homeHandler:$.proxy(function(){this.jump("/html5/")},this)}});var t=this.getQuery("from");t&&t.length>0&&(t=decodeURIComponent(t),this.urlFrom=t.substr(t.indexOf("#")+1)),this.headerview.show(),this.showLoading(),this.updatePage(function(){this.hideLoading();try{e.turning()}catch(t){}})},onShow:function(){this.showAfter()},getUrlParama:function(){var e="";return d.get()&&(e=d.getAttr("indexurl")),e},goBack:function(){var e=this,t=this.getUrlParama(),n=f.geturlQuery("from");n&&n!="index"?e.back("#"+n):e.back(t)},onHide:function(){this.els.citybox.show(),this.els.elassociate.hide()},selCity:function(){}});return y})