define(["libs","c","CommonStore","PayStore","PayModel","PayParentView","lipincardpay_html","cUtility","cWidgetFactory","paymentPipe","cUIInputClear","cUtilityCrypt","cUICore","Business","Util","cHybridFacade","cHybridShell"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){var g={hassubmit:!1},y=0,b=a.create("Guider"),w=0,E=0,S=0,x,T="",N="",C="",k="",L="",A="",O="",M="",D,P=!1,H=s.extend({pageid:"232006",hpageid:"232006",cardpay:r.PaymentWayStore.getInstance(),orderpay:r.OrderDetailStore.getInstance(),paymentcard:r.PayMentCardParamStore.getInstance(),touchPayStore:r.touchPayStore.getInstance(),extendParamsStore:r.ExtendInfoStore.getInstance(),tktErrorStore:r.tktErrorStore.getInstance(),alertArr:[],tpl:o,isSetPassWord:!1,totalAmount:0,onHide:function(){this.hideLoading(),this.alertArr.forEach(function(e,t){e&&e.hide&&e.hide()}),p&&p.alertArr.forEach(function(e,t){e&&e.hide&&e.hide()})},onCreate:function(){var e=this;e.render()},render:function(){this.$el.html(this.tpl),this.els={c_payment_index_amount:this.$el.find("#c_payment_index_amount"),c_lpk_password_forget:this.$el.find("#c_lpk_password_forget"),cardlist:this.$el.find("#artic_list"),se_textDetail:this.$el.find("#se_textDetail"),numinput:this.$el.find("#c_payment_numinput")},this.cardlisttpl=_.template(this.$el.find("#cardlist").html())},events:{"click #useBtn":"TouchPay","click #payBtn":"TouchPay","click #confirmBtn":"TouchPay","click [target='li-target']":"changecard"},onShow:function(){this.setTitle("携程钱包支付")},onLoad:function(){var e=this;P=!1,e.cardpay.getAttr("autoPay")?(y=0,e.showLoading(),e.cardpay.setAttr("autoPay",0),e.cardpay.setAttr("cancelWindControl",0),e.PostCheck(g.isPay)):e.showView();if(e.cardpay.getAttr("checkpwd")){var t=e.cardpay.getAttr("checkJson");e.cardpay.setAttr("checkJson",null),e.pwdCallSubmit(t)}},showOrderAmount:function(){var e=this,t=null,n=e.orderpay.getAttr("displayAmount")||0,r=e.transNumToFixedStr(e.orderpay.getAttr("origamount")||0),i=new Array;return i.push("<span class='pay-c666'>订单应付总额：</span>"),i.push("<span class='ft18'>"),i.push(r),i.push("</span>"),i.join("")},updatePage:function(){var e=this;u.isInApp()?(w=e.touchPayStore.getAttr("isTouchId")||0,e.CheckTouchId({bussinessType:1e3},function(t){t&&t.resultCode==0?(D=0,S=1,T=t.deviceInfo,N=t.wifi_mac,C=t.imei,k=t.vendorid,e.touchPayStore.setAttr("vendorid",k),e.touchPayStore.setAttr("deviceInfo",T),e.touchPayStore.setAttr("wifi_mac",N),e.touchPayStore.setAttr("imei",C)):S=0,e.showLoading(),e.isHasPass(e.initpage)})):(e.showLoading(),e.isHasPass(e.initpage))},initpage:function(e){var t=this;t.orderinfo=t.orderpay.get(),t.cardpayment=t.paymentcard.get(),t.orderinfo&&t.cardpayment?t.orderinfo.oid==t.cardpayment.orderid?(g=t.cardpayment.cardInfo,t.filltpldata(1)):(g.hassubmit=!1,t.paymentcard.resetParam(),t.paymentcard.setAttr("orderid",t.orderinfo.oid),t.loadData()):t.goBack()},TouchPay:function(e){var n=this;if(!this.isSetPassWord){var r=new t.ui.Alert({title:"提示信息",message:"请先设置支付密码，才能使用携程钱包支付",buttons:[{text:"取消",click:function(){this.hide()},type:t.ui.Alert.STYLE_CANCEL},{text:"去设置",click:function(){this.hide(),n.goto()},type:t.ui.Alert.STYLE_CONFIRM}]});r.show(),n.alertArr.push(r);return}var i=n.cardpay.getAttr("tktinfo")||{},s=n.cardpay.getAttr("walletlist")[0],o=i.tkts,a=n.$el.find('[data-name="rwy"]'),f=n.$el.find('[data-name="rwx"]'),l=n.$el.find('[data-name="qb"]'),c=[],h=[];y=0;var p=n.$(e.target);if(p&&p.hasClass("btndisabled"))return;f.length>0&&f.hasClass("yes")&&(h.push(1),c.push(1)),a.length>0&&a.hasClass("yes")&&(h.push(2),c.push(2)),l.length>0&&l.hasClass("yes")&&(h.push(3),s.walletstatus==2&&(y=1));if(h.length<1){n.paymentcard.setAttr("orderid",-1),D=1,w=0,n.touchPayStore.setAttr("isTouchId",0);var v=n.$el.find("#allcardList span[data-name]"),m=!0;v&&v.length>0&&_.each(v,function(e,t){$(e).hasClass("yes")&&(m=!1)}),m&&n.touchPayStore.setAttr("touchpaysubmit",0),n.orderpay.setAttr("amount",n.orderpay.getAttr("origamount"));var g=n.orderpay.getAttr("origamount");n.goBack();return}var b=c.length,E=null;for(var S=0,x=o.length;S<x;S++){E=o[S];for(var T=0;T<b;T++)if(E.tkttype==c[T]&&E.ticketstatus==2){y=1;break}}if(u.isInApp()&&w&&D===0){if(!!P)return;P=!0;var N=n.paymentcard;n.CheckTouchId({bussinessType:1001},function(e){setTimeout(function(){P&&(P=!1)},100);if(e.resultCode==0)n.touchPayStore.setAttr("touchPaySubmit",1),y=0,n.cardpay.setAttr("verifiedPhone",1),n.CheckTouchId({bussinessType:1003,token:M},function(e){L=e.RSAToken,n.touchPayStore.setAttr("RSAToken",L),n.CheckTouchId({bussinessType:1004},function(e){A=e.secretKeyGUID,n.touchPayStore.setAttr("secretKeyGUID",A),O=e.deviceGUID,n.touchPayStore.setAttr("deviceGUID",O),n.pay()})});else if(e.resultCode==1){var r=new t.ui.Alert({title:"提示信息",message:"无法验证指纹，请使用支付密码完成支付",buttons:[{text:"确认",click:function(){r.hide(),n.pwdPay()},type:t.ui.Alert.STYLE_CONFIRM}]});r.show(),n.alertArr.push(r)}else e.resultCode==101?n.pwdPay():d.getSystemVer()&&d.getSystemVer().platform==4&&n.pwdPay()})}else D=1,n.pay()},pwdPay:function(){var e=this;D=1,w=0,e.touchPayStore.setAttr("isTouchId",0),e.choosepwd()},pay:function(e){var t=this;w&&t.showLoading();if(D)t.choosepwd();else if(g.isPay){var n="";if(g.noBill&&t.orderinfo.needInvoice.toString()=="true")if(t.orderinfo.bustype==101||t.orderinfo.bustype==102||t.orderinfo.bustype==8||t.orderinfo.bustype==301||t.orderinfo.bustype==303||t.orderinfo.bustype==302)if(t.orderinfo.includeInTotalPrice.toString()=="true"){var r=d.folatcount(t.orderinfo.origamount,t.orderinfo.invoiceDeliveryFee,"-");t.paymentcard.setAttr("totalamount_nobill",r),n="礼品卡全额支付不提供报销凭证，扣除配送费后，应付￥"+r}else n="由于你选择礼品卡支付，我们将不提供报销凭证";else if(t.orderinfo.bustype==11||t.orderinfo.bustype==1002)n="由于你选择礼品卡支付，我们将不提供报销凭证";n!=""?t.showAlert(n,t.orderinfo.bustype):(t.savecardinfo(1),t.PostCheck(1))}else g.hassubmit=!0,t.savecardinfo(1),t.getPaymentDetail(!0),t.cardpay.setAttr("tktuse",1),t.PostCheck(0)},showAlert:function(e,n){var r=this;this.promptAlert=new t.ui.Alert({title:"提示信息",message:e,buttons:[{text:"取消",click:function(){this.hide(),r.hideLoading()},type:t.ui.Alert.STYLE_CANCEL},{text:"确认",click:function(){this.hide();if(n==301||n==302)r.orderpay.setAttr("needInvoice",!1);else if(n==101||n==102){r.orderpay.setAttr("needInvoice",!1);var e=d.folatcount(r.orderinfo.origamount,r.orderinfo.invoiceDeliveryFee,"-");r.orderpay.setAttr("totalamount",e)}r.showLoading(),r.savecardinfo(1),r.PostCheck(1)},type:"confirm"}]}),this.promptAlert.show(),r.alertArr.push(this.promptAlert)},getPaymentDetail:function(e,t){var n=this,r=n.cardpay.getAttr("checkpwd");n.cardpay.setAttr("checkpwd",null);var i=n.$el.find('[data-name="rwy"]'),s=n.$el.find('[data-name="rwx"]'),o=n.$el.find('[data-name="qb"]'),u=g.cardlist[0]||{},a=g.cardlist[1]||{},f=g.walletlist[0]||{},l=null,c=null,h=null,p={},v=0;t&&(v=n.orderinfo.invoiceDeliveryFee||0),p.cardamount=0,p.qbamount=0,p.paytype=0,p.cardpay=!1,p.qbpay=!1;var m=new Array,y=n.cardpay.getAttr("tktinfo")||{},b=n.cardpay.getAttr("walletlist")||[],w=[];return o.length>0&&o.hasClass("yes")&&(p.qbamount+=f.useamoumt,p.qbpay=!0,h={},h.paymentwayid=b[0].paymentwayid,h.amount=p.qbamount,h.pwd=r,w.push(h)),s.length>0&&s.hasClass("yes")&&(v>0?a.useamoumt>v?(a.useamoumt=d.folatcount(a.useamoumt,v,"-"),p.cardamount=p.cardamount+a.useamoumt,p.cardpay=!0,v=0):(v=d.folatcount(v,a.useamoumt,"-"),a.useamoumt=0,p.cardpay=!1):(p.cardamount+=a.useamoumt,p.cardpay=!0),c={},c.tkttype=a.tkttype,c.pwd=r,c.amt=a.useamoumt,c.tktid=a.tktid),c&&m.push(c),i.length>0&&i.hasClass("yes")&&(v>0?u.useamoumt>v?(u.useamoumt=d.folatcount(u.useamoumt,v,"-"),p.cardamount=p.cardamount+u.useamoumt,p.cardpay=!0,v=0):(v=d.folatcount(v,u.useamoumt,"-"),u.useamoumt=0,p.cardpay=!1):(p.cardamount+=u.useamoumt,p.cardpay=!0),l={},l.tkttype=u.tkttype,l.pwd=r,l.amt=u.useamoumt,l.tktid=u.tktid),l&&m.push(l),p.cardpay&&(p.paytype+=1),p.qbpay&&(p.paytype+=32),p.tktinfo={paymentwayid:y.paymentwayid,tktamount:p.cardamount,pwd:r,tkts:m},p.walletpayinfo=w,e&&(this.paymentcard.setAttr("paymentdetail",p),this.paymentcard.setAttr("tktinfo",p.tktinfo)),p},gopay:function(){var e=this,n=e.getPaymentDetail(!0,e.paymentcard.getAttr("totalamount_nobill"))||{},r=null,i=null,s=e.cardpay.getAttr("vcode");if(n.cardpay){r=n.tktinfo;for(var o=0;o<r.tkts.length;o++)r.tkts[o].vcode=s}n.qbpay&&(i=n.walletpayinfo,i[0].vcode=s);var a={opttype:1,paytype:0,tktinfo:r,walletpayinfo:i},l=e.paymentcard;w&&(a.touchpay={deviceinfo:{devguid:O,devmod:T,wifimac:N,imei:C,vendorid:k},keyguid:A,token:L},e.paymentcard.setAttr("statisticPay",5));var c={};this.orderpay&&this.orderpay.get()&&(c=p.getRequestHeader()),a.head=c;var h=decodeURIComponent(this.orderinfo.sback),d=function(n){n=n||{};if(u.isInApp()){if(!n.resultBody){e.hideLoading(),e.showToast(n.errorInformation||"网络不给力,请稍候重试");return}n=JSON.parse(n.resultBody)}if(!p.lipinCardExcuteCallback.call(null,n)){e.tktErrorStore.setAttr("tktUsed",1);var r=new t.ui.Alert({title:"提示信息",message:"支付失败，请重新尝试",buttons:[{text:"确定",click:function(){p.removePayCardStore(),p.goHome.call(e)},type:t.ui.Alert.STYLE_CONFIRM}]});r.show(),e.alertArr.push(r);return}p.setTempOid(n);if(typeof n.res!="undefined"&&n.res){e.hideLoading(),e.showToast("网络不给力,请稍候重试");return}if(n.rc==0)u.isInApp()?p.jump2AppPage(!0,n,h):p.jump2H5Page(!0,n,h);else if(n.rc<100){g.hassubmit=!1,e.hideLoading();if(n.rc==4){var r=new t.ui.Alert({title:"提示信息",message:n.rmsg||"网络不给力,请稍候重试",buttons:[{text:"好的",click:function(){u.isInApp()?p.jump2AppPage(!0,n,h):p.jump2H5Page(!0,n,h)},type:t.ui.Alert.STYLE_CONFIRM}]});r.show(),e.alertArr.push(r)}else if(n.rc==7||n.rc==10){y=1;var r=new t.ui.Alert({title:"提示信息",message:n.rmsg||"网络不给力,请稍候重试",buttons:[{text:"确定",click:function(){r.hide(),e.cardpay.setAttr("verifiedPhone",null),e.PostCheck(g.isPay)},type:t.ui.Alert.STYLE_CONFIRM}]});r.show(),e.alertArr.push(r)}else n.rc==9?e.showToast(n.rmsg||"网络不给力,请稍候重试",2,function(){e.pwdPay()}):e.showToast(n.rmsg||"网络不给力,请稍候重试")}else{g.hassubmit=!1;var i=decodeURIComponent(e.orderinfo.eback||"");u.isInApp()?p.jump2AppPage(!1,n,i):p.jump2H5Page(!1,n,i)}},v=p.getRequestHeader(),m=JSON.stringify(v);e.extendParamsStore.getAttr("isRealTimePay")?(a.opadbitmp=4,f.payV3(a,d,m,function(){e.hideLoading(),g.hassubmit=!1,e.showToast("网络不给力,请稍候重试")})):f.pay(a,d,m,function(){e.hideLoading(),g.hassubmit=!1,e.showToast("网络不给力,请稍候重试")})},savecardinfo:function(e){var t=this.cardpay.getAttr("checkpwd");g.pwd=t;var n=this.cardpay.getAttr("vcode");g.walletlist&&g.walletlist.length>0&&(g.walletlist[0].vcode=n);if(g.cardlist&&g.cardlist.length>0)for(var r=0;r<g.cardlist.length;r++)g.cardlist[r].vcode=n;this.paymentcard.setAttr("cardInfo",g),e&&this.orderpay.setAttr("amount",g.laveamount)},isAllPay:function(e){return e=e||0,e>=this.orderinfo.totalamount?!0:!1},freshCard:function(e){var t=this;if(e)if(e.ename=="qb"&&e.status!=2||e.ename!="qb"&&e.status!=1){this.$el.find(".span-"+e.ename).text(t.transNumToFixedStr(e.useamoumt));var n=t.$el.find('[data-name="'+e.ename+'"]');n.length>0&&e.ischecked&&n.addClass("yes")}e.unable||e.ename!="qb"&&e.status==1||e.ename=="qb"&&e.status==2?this.$el.find(".li-"+e.ename).addClass("invalidate"):!e.unable&&(e.ename!="qb"&&e.status==0||e.ename=="qb"&&e.status==1)&&this.$el.find(".li-"+e.ename).removeClass("invalidate")},freshByLeavaAmount:function(){var e=g.laveamount||0;g.isPay?(this.$el.find("#span_leavaamount").hide(),this.$el.find("#confirmBtn").hide(),this.$el.find("#useBtn").hide(),this.$el.find("#payBtn").show()):(this.$el.find(".laveamount").text(this.transNumToFixedStr(e)),this.$el.find("#payBtn").hide(),this.$el.find("#confirmBtn").hide(),this.$el.find("#span_leavaamount").show(),this.$el.find("#useBtn").show()),g.isPay?(this.$el.find("#isAllPay_div").show(),this.$el.find("#se_textDetail").show()):(this.$el.find("#isAllPay_div").hide(),this.$el.find("#c_payment_lipincard_text1").css("display")=="none"&&this.$el.find("#se_textDetail").hide())},renderList:function(){var e=this,t=g.cardlist[0],n=g.cardlist[1],r=g.walletlist[0];e.freshCard(t),e.freshCard(n),e.freshCard(r)},decimalByBu:function(e,t){var n=this;t=t||!1;var r=e+"",i,s=this.orderinfo.bustype;return n.disTingByBust()||t?(i=/([0-9]+\.[0-9]{2})[0-9]*/,parseFloat(r.replace(i,"$1"))):parseInt(r,10)},disTingByBust:function(){var e=this,t=p.supportDecimalBu(),n=e.orderinfo.bustype,r=!1;for(var i=0;i<t.length;i++)if(t[i]==n){r=!0;break}return r},changecard:function(e){e.preventDefault();var t=this,n=$(e.currentTarget);if(n.length==0||n.hasClass("invalidate"))return;var r=n.find("span[data-name]");if(!(r&&r.length>0)){console.log("元素缺失");return}r.toggleClass("yes");var i=g.cardlist[0],s=g.cardlist[1],o=g.walletlist[0],u=t.$el.find('[data-name="rwy"]'),a=t.$el.find('[data-name="rwx"]'),f=t.$el.find('[data-name="qb"]');g.noBill=!1,g.isPay=!1,g.laveamount=this.orderinfo.totalamount,i.useamoumt=0,s.useamoumt=0,o.useamoumt=0,i.unable=!1,s.unable=!1,o.unable=!1;if(u.length>0){if(u.hasClass("yes"))if(t.isAllPay(i.ableamount))i.useamoumt=t.decimalByBu(this.orderinfo.totalamount),g.isPay=!0,g.noBill=!0,g.laveamount=0;else{i.useamoumt=t.decimalByBu(i.ableamount),g.isPay=!1;var l=d.folatcount(g.laveamount,i.useamoumt,"-");g.laveamount=t.decimalByBu(l)}i.ischecked=u.hasClass("yes")}if(a.length>0){if(a.hasClass("yes"))if(g.isPay)s.unable=!0,a.removeClass("yes"),g.noBill=!0;else if(s.ableamount>=g.laveamount)s.useamoumt=t.decimalByBu(g.laveamount),g.isPay=!0,g.laveamount=0,g.noBill=!0;else{s.useamoumt=t.decimalByBu(s.ableamount),g.isPay=!1;var l=d.folatcount(g.laveamount,s.useamoumt,"-");g.laveamount=t.decimalByBu(l)}else g.isPay&&(s.unable=!0,g.noBill=!0);s.ischecked=a.hasClass("yes")}if(f.length>0){if(f.hasClass("yes"))if(g.isPay)g.noBill=!0,o.unable=!0,f.removeClass("yes");else if(o.ableamount>=g.laveamount)o.useamoumt=t.decimalByBu(g.laveamount),g.isPay=!0,g.laveamount=0;else{o.useamoumt=t.decimalByBu(o.ableamount),g.isPay=!1;var l=d.folatcount(g.laveamount,o.useamoumt,"-");g.laveamount=t.decimalByBu(l)}else g.isPay&&(o.unable=!0,g.noBill=!0);o.ischecked=f.hasClass("yes")}g.cardlist[0]=i,g.cardlist[1]=s,g.walletlist[0]=o,t.renderList(),t.freshByLeavaAmount();var c=t.$el.find("#allcardList span[data-name]");if(c){var h=!0;_.each(c,function(e){$(e).hasClass("yes")&&(h=!1)}),h&&(t.$el.find("#useBtn").hide(),t.$el.find("#payBtn").hide(),t.$el.find("#confirmBtn").show(),this.$el.find("#span_leavaamount").hide())}},loadData:function(){var e=this,t=this.cardpay.get(),n={},r={};n.isshow=!1,r.isshow=!1;if(t&&t.tktinfo&&t.tktinfo.tkts){var i=t.tktinfo.tkts;for(var s=0;s<i.length;s++)i[s].amount=this.handlemoney(i[s].amount,!0),i[s].tkttype==1?(n=i[s],n.name="任我行",n.ename="rwx",n.ableamount=this.handlemoney(n.amount,!0),n.useamoumt=0,n.isshow=!0):i[s].tkttype==2&&(r=i[s],r.name="任我游",r.ename="rwy",r.ableamount=this.handlemoney(r.amount,!0),r.useamoumt=0,r.isshow=!0);g.cardlist=[],g.laveamount=this.orderinfo.totalamount,g.cardlist.push(r),g.cardlist.push(n)}g.walletlist=[];var o={};o.isshow=!1,t.walletlist&&t.walletlist.length>0&&(o=t.walletlist[0],o.ename="qb",o.ableamount=e.handlemoney(o.cashbalance,!0),o.useamoumt=0,o.isshow=!0),g.walletlist.push(o);if(g.cardlist.length>0||g.walletlist.length>0)this.paymentcard.setAttr("cardInfo",g),this.filltpldata()},filltpldata:function(e){var t=this,n=this.paymentcard.get()&&this.paymentcard.get().cardInfo;this.els.cardlist.html(this.cardlisttpl(n)),this.els.fadekey=this.els.cardlist.find("#c_payment_fadekey"),this.els.numinput=this.els.cardlist.find("#c_payment_numinput");var r=d.getSystemVer();r.platform==3&&t.$el.find("#c_payment_numinput").show(),this.hideLoading(),e&&(t.renderList(),t.freshByLeavaAmount(),t.setCurState());var i=this.orderpay.get().bustype,s=this.cardpay.get().dsettings;for(var o in s)if(s[o].type==10&&s[o].value){var u=s[o].value;u=u.replace(/\u000a/img,"<br />"),this.$el.find("#c_payment_lipincard_text1").html(u),this.$el.find("#c_payment_lipincard_text1").show(),t.$el.find("#artic_list").css({height:"100%"}),setTimeout(function(){t.$el.find("#artic_list").height(t.$el.find("#artic_list").height()+48)},0),this.$el.find("#se_textDetail").show()}else this.$el.find("#isAllPay_div").css("display")=="none"&&this.$el.find("#se_textDetail").hide()},isHasPass:function(e){var t=this,n={},r=function(n){var r=t.$el.find(".catxt"),i=n||{};if(u.isInApp()){if(!n.resultBody){t.hideLoading(),t.showToast("网络不给力,请稍候重试"),t.goBack();try{p.exceptionInfoCollect({bustype:2,excode:3,extype:2,exdesc:"设置密码错误"})}catch(s){}p.removePayCardStore(),p.goHome.call(t);return}i=JSON.parse(n.resultBody)}if(!i||i.result!=0){t.hideLoading(),t.showToast(i.resultmesg||"网络不给力,请稍候重试");return}t.hideLoading(),i.accountinfo&&(x=i.accountinfo.phone,i.accountinfo.stabitmap&1&&(D=1,t.isSetPassWord=1),i.accountinfo.stabitmap&2?(D=0,E=1,M=i.paytoken,E&&S&&(w=1,t.touchPayStore.setAttr("isTouchId",1))):(w=0,t.touchPayStore.setAttr("isTouchId",0),t.paymentcard.setAttr("statisticPay",6))),e&&e.call(t)};this.orderpay&&this.orderpay.get()&&(n=p.getRequestHeader());var i=JSON.stringify(n),s=t.orderpay.get()||{},o=t.paymentcard.get()||{},a={svr:0,bustype:s.bustype,oid:s.oid,requestid:s.requestid,opbitmap:3};S&&u.isInApp()&&(a.deviceinfo={devguid:O,devmod:T,wifimac:N,imei:C,vendorid:k},a.opbitmap=a.opbitmap+4),f.getPhoneNum(a,r,i,function(){t.hideLoading();try{p.exceptionInfoCollect({bustype:2,excode:3,extype:2,exdesc:"设置密码错误"})}catch(e){}p.removePayCardStore(),p.goHome.call(t)})},"goto":function(){var e=this;e.paymentcard.setAttr("orderid",-1);var t=e.orderpay.getAttr("from"),n=this.$el.find(".catxt").text(),r="chgpwd",i=location.href,s={islogin:e.orderpay.getAttr("isload"),auth:e.orderpay.getAttr("auth"),time:"2099/01/01 00:00:00",isuser:e.orderpay.getAttr("isload")},o=encodeURIComponent(c.Base64.encode(JSON.stringify(s))),a={WALLET_AUTH_INFO:o};d.addCookie(a),localStorage.setItem("WALLET_AUTH_INFO",o);var f={from:"",eback:""};if(u.isInApp()){var l=this.getRoot()+"#lipincardpay";f.eback=f.from=l;var h=encodeURIComponent(c.Base64.encode(JSON.stringify(f)));b.cross({path:"wallet",param:"index.html#"+r+"?token="+h})}else{t="https://"+location.host,f.eback=f.from=i;var h=encodeURIComponent(c.Base64.encode(JSON.stringify(f)));this.jump(t+"/webapp/wallet/index.html#"+r+"?token="+h)}},goBack:function(){var e=this,t=e.orderpay.getAttr("indexurl");e.back(t)},handlemoney:function(e,t){var n=e+"",r,i=this.orderinfo.bustype;return t?(r=/([0-9]+\.[0-9]{2})[0-9]*/,parseFloat(n.replace(r,"$1"))):i==4||i==3001||i==14?(r=/([0-9]+\.[0-9]{1})[0-9]*/,parseFloat(n.replace(r,"$1"))):parseInt(n,10)},setCurState:function(){var e=this,t=e.$el.find("#allcardList span[data-name]"),n=new Array;t&&_.each(t,function(e){n.push($(e).hasClass("yes"))}),e.paymentcard.setAttr("curstate",n)},backChangeWarn:function(){var e=this;e.hasClick=1,e.cardpay.getAttr("cancelWindControl")&&(g.hassubmit=!1,e.orderpay.setAttr("amount",e.orderpay.getAttr("origamount")),e.paymentcard.setAttr("cardInfo",null));if(g.hassubmit){var n=e.paymentcard.getAttr("curstate"),r=e.$el.find("#allcardList span[data-name]"),i=!0,s=!1;r&&r.length>0&&_.each(r,function(e,t){n[t]!=$(e).hasClass("yes")&&(s=!0),$(e).hasClass("yes")&&(i=!1)});if(i){var o=new t.ui.Alert({title:"提示信息",message:"确认不使用携程钱包的金额？",buttons:[{text:"再想想",click:function(){e.hasClick=0,this.hide()},type:t.ui.Alert.STYLE_CANCEL},{text:"不使用",click:function(){e.hasClick=0,this.hide(),e.paymentcard.setAttr("orderid",-1),D=1,w=0,e.touchPayStore.setAttr("isTouchId",0),e.touchPayStore.setAttr("touchPaySubmit",0),e.orderpay.setAttr("amount",e.orderpay.getAttr("origamount")),e.goBack()},type:t.ui.Alert.STYLE_CONFIRM}]});o.show(),e.alertArr.push(o)}else if(!i&&s){var o=new t.ui.Alert({title:"提示信息",message:"您修改了使用选项 请重新确认您使用的钱包金额",buttons:[{text:"放弃修改",click:function(){e.hasClick=0,D=1,w=0,e.touchPayStore.setAttr("isTouchId",0),e.touchPayStore.setAttr("touchPaySubmit",0),this.hide(),e.goBack()},type:t.ui.Alert.STYLE_CANCEL},{text:"确定",click:function(){e.hasClick=0,this.hide()},type:t.ui.Alert.STYLE_CONFIRM}]});o.show(),e.alertArr.push(o)}else e.goBack()}else{var r=e.$el.find("#allcardList span[data-name]");if(r&&r.length>0){var u=!1;_.each(r,function(e,t){$(e).hasClass("yes")&&(u=!0)});if(u){var o=new t.ui.Alert({title:"提示信息",message:"您修改了使用选项 请重新确认您使用的钱包金额",buttons:[{text:"放弃修改",click:function(){e.hasClick=0,this.hide(),e.paymentcard.setAttr("orderid",-1),D=1,w=0,e.touchPayStore.setAttr("isTouchId",0),i&&e.touchPayStore.setAttr("touchPaySubmit",0),e.goBack()},type:t.ui.Alert.STYLE_CANCEL},{text:"确定",click:function(){e.hasClick=0,this.hide()},type:t.ui.Alert.STYLE_CONFIRM}]});o.show(),e.alertArr.push(o)}else e.paymentcard.setAttr("orderid",-1),e.goBack()}else e.paymentcard.setAttr("orderid",-1),e.goBack()}},transNumToFixedStr:function(e,t,n){e+="";if(!e)return"";var r=/^\d*\.*\d+$/;if(!r.test(e))return e;t=t||2,n=n||"￥";var i=e.split("."),s="",o=0;i.length>1&&(o=i[1].length,s=i[1]);for(var u=0;u<t-o;u++)s+="0";return i[1]=s,n+i.join(".")},showView:function(){var e=this;e.hasClick=0,this.headerview.set({title:"携程钱包支付",view:this,openAds:!0,back:!0,home:!1,events:{returnHandler:function(){return e.hasClick?!0:(e.backChangeWarn(),!0)}}}),this.headerview.show();try{e.turning()}catch(t){}D=1,e.updatePage()},PostCheck:function(e){var t=this;y?x?(t.cardpay.setAttr("isGetPassWordfrom1501",1),t.cardpay.setAttr("verifyMobile",x),t.cardpay.setAttr("seniortype",1),p.VerifyPhone.call(t,"lipincardpay")):(t.cardpay.setAttr("isGetPassWordfrom1501",0),e?t.gopay():t.goBack()):e?t.gopay():t.goBack()},CheckTouchId:function(e,t,n){var r={reason:"",businessType:e.bussinessType,token:e.token},i=11e3;typeof n=="number"&&n===1&&(i=12e3);var s=new m.Fn("do_business_job",function(e){return t(e)});s.run(4,i,r)},pwdCallSubmit:function(e){var t=this;t.showLoading(),p.setTempOid(e),t.paymentcard.setAttr("totalamount_nobill",null),w&&(t.paymentcard.setAttr("statisticPay",4),w=0),t.touchPayStore.setAttr("isTouchId",0),t.touchPayStore.setAttr("touchPaySubmit",0);if(g.isPay){var n="";if(g.noBill&&t.orderinfo.needInvoice.toString()=="true")if(t.orderinfo.bustype==101||t.orderinfo.bustype==102||t.orderinfo.bustype==8||t.orderinfo.bustype==301||t.orderinfo.bustype==303||t.orderinfo.bustype==302)if(t.orderinfo.includeInTotalPrice.toString()=="true"){var r=d.folatcount(t.orderinfo.origamount,t.orderinfo.invoiceDeliveryFee,"-");t.paymentcard.setAttr("totalamount_nobill",r),n="礼品卡全额支付不提供报销凭证，扣除配送费后，应付￥"+r}else n="由于你选择礼品卡支付，我们将不提供报销凭证";else if(t.orderinfo.bustype==11||t.orderinfo.bustype==1002)n="由于你选择礼品卡支付，我们将不提供报销凭证";n!=""?t.showAlert(n,t.orderinfo.bustype):(t.savecardinfo(1),t.PostCheck(1))}else g.hassubmit=!0,t.savecardinfo(1),t.getPaymentDetail(!0),t.cardpay.setAttr("tktuse",1),t.PostCheck(0)},choosepwd:function(){var e=this;u.isInApp()?e.CheckTouchId({bussinessType:12e3},function(t){if(t.resultCode==0){var n=t.pwd||"";e.cardpay.setAttr("checkpwd",n),e.pwdCallSubmit({res:!0,msg:"验证成功!"})}else t.resultCode==2&&e.goto()},1):e.forward("verfiedpsd?from=lipincardpay")}});return H})