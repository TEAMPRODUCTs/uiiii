define(["c","cWidgetFactory","PayModel","PayStore","CommonStore","cUtility","Config"],function(e,t,n,r,i,s,o){var u=t.create("Guider"),a=r.PayMentCardParamStore.getInstance(),f=r.touchPayStore.getInstance(),l=r.PaymentWayStore.getInstance(),c=r.OrderDetailStore.getInstance(),h=r.ExtendInfoStore.getInstance(),p=r.SelectBankStore.getInstance(),d={};return d.isPreAuth=function(){var e=!1,t=h&&h.get();return t&&t.IsNeedPreAuth&&(e=!0),e},d.getRiskCtrl=function(){var e=0;return h&&h.get()&&(e=h.get().IsNeedCardRisk?1:0),e},d.getPublicParams=function(e){e=e||{};var t=this.getSystemVer(),n=c.get(),r=h.get()||{},i=p.get()||{},o=n.hasLastPayWay,u=l.get(),v=parseInt(Math.random()*1e5);e.ver=t.ver,e.plat=t.platform,e.requestid=n.requestid,e.opttype=e.opttype,e.bustype=n.bustype,e.usetype=r.useEType||1,e.subusetype=this.isPreAuth()?1:0,e.subpay=r.subPayType||0,e.opadbitmp?e.opadbitmp+=this.getRiskCtrl():e.opadbitmp=this.getRiskCtrl(),e.forcardfee=e.forcardfee||null,e.forcardcharg=e.forcardcharg||0,e.stype=e.stype||0,e.paytype=e.paytype,e.payrestrict=r.payrestrict||{},e.oinfo={oid:n.oid,oidex:n.oid,odesc:n.title,currency:n.currency||"CNY",oamount:n.totalamount,displayCurrency:n.displayCurrency||"CNY",displayAmount:n.displayAmount,extno:n.extno,recall:n.recall},f.getAttr("touchPaySubmit")&&(e.opadbitmp+=16);if(e.cardinfo){e.cardinfo.paymentwayid=i.paymentwayid,e.cardinfo.opttype=e.cardinfo.opttype||"1",e.cardinfo.cardamount=e.cardinfo.cardamount,e.cardinfo.status=i.status;var m=null;e.cardinfo.status&256&&l.getAttr("isGetPassWordfrom1801")&&(m=l.getAttr("vcode")?l.getAttr("vcode"):v,e.opadbitmp+=8),e.statistic=i.status&128?1:o?2:3;if(e.cardinfo.addinfo){var g=e.cardinfo.addinfo;e.cardinfo.addinfo={typemain:i.typemain,typeid:i.typeid,cardno:g.cardno,cvv2:g.cvv2,expire:g.expire,holder:g.holder,idcardtype:g.idcardtype,idcardno:g.idcardno,islast4:g.islast4,category:i.category,mobile:g.mobile,refid:g.refid,vcode:m?m:g.vcode}}else e.cardinfo.addinfo=null;if(e.cardinfo.checkinfo){var y=e.cardinfo.checkinfo;e.cardinfo.checkinfo={typemain:i.typemain,typeid:i.typeid,cardnumfl:i.cardnumfl,last4:i.lastcode,cvv2:y.cvv2,cardinfoid:i.cardinfoid,expire:y.expire,category:i.category,mobile:y.mobile,refid:y.refid,vcode:m?m:y.vcode,islast4:y.islast4,cardno:y.cardno,holder:y.holder,idcardtype:y.idcardtype,idcardno:y.idcardno}}else e.cardinfo.checkinfo=null;if(e.cardinfo.updateinfo){var b=e.cardinfo.updateinfo;e.cardinfo.updateinfo={typemain:i.typemain,typeid:i.typeid,cardnumfl:i.cardnumfl,last4:i.lastcode,cvv2:b.cvv2,cardinfoid:i.cardinfoid,expire:b.expire,category:i.category,mobile:b.mobile,refid:b.refid,vcode:m?m:b.vcode,islast4:b.islast4,cardno:b.cardno,cardinfoid:i.cardinfoid,holder:b.holder,idcardtype:b.idcardtype,idcardno:b.idcardno}}else e.cardinfo.updateinfo=null}else e.cardinfo=null;if(e.thirdpartyinfo){var w=e.thirdpartyinfo;e.thirdpartyinfo={paymentwayid:w.paymentwayid,typeid:w.typeid,subtypeid:w.subtypeid,typecode:w.typecode,thirdcardnum:w.thirdcardnum,amount:w.amount},e.statistic=i.thirdstatus?1:o?2:3}else e.thirdpartyinfo=null;if(e.cashinfo&&e.cashinfo.length>0){var E=e.cashinfo;e.cashinfo=[{paymentwayid:n.CashInfo[0].paymentwayid,amount:E[0].amount,receivebranch:r.CashReceiveBranch,receivesite:r.CashReceiveSite}],e.statistic=i.cashstatus?1:o?2:3}else e.cashinfo=null;var S=a.get(),x=S?S.paymentdetail:null;if(S&&S.orderid!=-1&&x&&x.cardamount+x.qbamount>0){if(x.cardpay){var T=u.tktinfo.tkts;e.tktinfo=x.tktinfo;if(l.getAttr("isGetPassWordfrom1501"))if(l.getAttr("vcode"))for(var N=0;N<e.tktinfo.tkts.length;N++)e.tktinfo.tkts[N].vcode=l.getAttr("vcode");else for(var C=0;C<T.length;C++)for(var k=0;k<e.tktinfo.tkts.length;k++)e.tktinfo.tkts[k].tkttype==T[C].tkttype&&T[C].ticketstatus==2&&l.getAttr("isGetPassWordfrom1501")&&(e.tktinfo.tkts[k].vcode=v)}x.qbpay&&(e.walletpayinfo=x.walletpayinfo,l.getAttr("isGetPassWordfrom1501")&&(l.getAttr("vcode")?e.walletpayinfo[0].vcode=l.getAttr("vcode"):u.walletlist[0].walletstatus==2&&l.getAttr("isGetPassWordfrom1501")&&(e.walletpayinfo[0].vcode=v))),e.paytype=e.paytype*1+x.paytype}if(s.isInApp()&&f.getAttr("touchPaySubmit")){var L=f.get(),A=L.deviceGUID||"",O=L.deviceInfo||"",M=L.wifi_mac||"",_=L.imei||"",D=L.vendorid||"",P=L.secretKeyGUID||"",H=L.RSAToken||"";e.touchpay={deviceinfo:{devguid:A,devmod:O,wifimac:M,imei:_,vendorid:D},keyguid:P,token:H}}var B=d.getCoordinate();B&&B.latitude&&(e.geos=[{type:"1",lat:B.latitude,lon:B.longitude}]),r.ActivityKey&&(e.actkey=r.ActivityKey,e.actcount=r.MaxActivityCount||0);if(e.statistic){var j=a.getAttr("statisticPay");j?e.statistic+="|"+j:e.statistic=j}return e},d.getCoordinate=function(){var e=null;return s.isInApp()&&(e=JSON.parse(window.localStorage.getItem("CINFO"))),e},d.folatcount=function(e,t,n){var r=e.toString().indexOf("."),i=t.toString().indexOf(".");if(r<0&&i<0)return n=="-"?parseInt(e,10)-parseInt(t,10):parseInt(e,10)+parseInt(t,10);var o=r>0?e.toString().split(".")[1].length:0,u=i>0?t.toString().split(".")[1].length:0;if(s.isInApp()){var a=1e3;return n=="-"?(e*a-t*a)/a:(e*a+t*a)/a}var a=1e3,f=parseInt(e*a,10),l=parseInt(t*a,10);return n=="-"?(f-l)/a:(f+l)/a},d.geturlQuery=function(e){return Lizard.P(e)},d.getSystemVer=function(){var e={platform:5,ver:601};if(s.isInApp()){var t=JSON.parse(localStorage.APPINFO);e.platform=t.platform&&t.platform==1?3:4}return e},d.remain2Num=function(e){e+="";var t=/([0-9]+\.[0-9]{2})[0-9]*/;return parseFloat(e.replace(t,"$1"))},d.addCookie=function(e){var t="";$.each(e,function(e,n){t=e+"="+n,document.cookie=t})},d.getCookie=function(){var e=document.cookie||"",t=e.split(";");if(t.length<=0)return null;var n={};return $.each(t,function(e,t){var r=t.split("=");r.length>2&&(n[r[0]]=r[1])}),n},d.getEnvironment=function(){var e=location.host;return s.isInApp()?s.isPreProduction()=="1"?"BL_APP":s.isPreProduction()=="0"?"CS_APP":s.isPreProduction()=="2"?"UAT_APP":"SC_APP":e.match(/^m\.ctrip\.com/i)||e.match(/^secure\.ctrip\.com/i)?"SC_WEB":e.match(/^(localhost|172\.16|127\.0)/i)?"BD_WEB":e.match(/^10\.8\.2\.111/i)||e.match(/^10\.8\.5\.10/i)?"BL_WEB":e.match(/^secure\.(fws|fat19)\.qa\.nt\.ctripcorp\.com|^210\.13\.100\.191/i)?"CS_WEB":/^secure\.(uat)\.qa\.nt\.ctripcorp\.com/i.test(e)?"UAT_WEB":e.match(/^secure\.(fws|fat18)\.qa\.nt\.ctripcorp\.com|^140\.20\.228\.101/i)?"CS_WEB":"SC_WEB"},d.placeholder=function(e){var t=this.getSystemVer(),n=this;if(t.platform==4){var r=window,i=$(r).height(),s=null;e.each(function(e,t){var o=$('<span style="position:absolute;top:0px" class="c_global_holder"></span>'),u=$(t);setTimeout(function(){var e=u.offset().left-5;o.css({left:e+"px",color:"#A9A9A9"}).text(t.getAttribute("placeholder")),u.removeAttr("placeholder").after(o)},0),o.click(function(e){n.stopEvent(e),t.focus()}),u.on("focus",function(e){n.stopEvent(e);var t=$(this);this.value!=""&&o.hide(),s&&clearTimeout(s),s=setTimeout(function(){var e=t.closest("section#c_payment_index_used_list").height(),n=e+118+$("#c_pay_index_lpk").height(),s=i-(i-$(r).height()),o=t.offset().top,u=n-o,a=o-(s-(n-o));s>=u&&r.scrollTo(0,a),t=null},700)}),u.on("input",function(){var e=this.value;e.length>0?o.hide():o.show()})})}},d.isInWeichat=function(){var e=window.navigator.userAgent;return e.indexOf("MicroMessenger")>-1?!0:!1},d.stopEvent=function(e){e&&e.stopPropagation&&e.preventDefault&&(e.stopPropagation(),e.preventDefault())},d.verifyCodeControl=function(){var e=60,t=null,n=null,r=this,i=function(i,s){var o=r.$el.find("#"+i),u=r.$el.find("#"+s);t&&(clearTimeout(n),n=t=null,e=60),u.hide(),o.html('<div class="greyload-icon">&nbsp;<span class="cui-pro-radius"></span><span class="greylogo"></span></div>'),o.show()},s=function(e,t){var n=r.$el.find("#"+e),i=r.$el.find("#"+t);n.text("获取验证码"),n.hide(),i.show()},o=function(i,s,o){var u=r.$el.find("#"+i),a=r.$el.find("#"+s);u.html('<span style="line-height:15px; display:inline-block; padding-top:6px;">60秒后<br/>重新获取</span>'),t?(clearTimeout(n),n=t=null,e=60):t=function(){var u=r.$el.find("#"+i),a=r.$el.find("#"+s);return e>=0?(u.html('<span style="line-height:15px; display:inline-block; padding-top:6px;">'+e+"秒后<br>重新获取"+"</span>"),e--,o?n=setTimeout(arguments.callee,1e3):(clearTimeout(n),n=t=null,e=60),1):(n=t=null,e=60,u.text("获取验证码"),u.hide(),a.show(),1)}()};return{showLoading:i,hideLoading:s,runVerifyCode:o}},d.transNumToFixedArray=function(e,t,n){e+="";if(!e)return"";var r=/^\d*\.*\d+$/;if(!r.test(e))return e;t=t||2;var i=e.split("."),s="",o=0;i.length>1&&(o=i[1].length,s=i[1]);for(var u=0;u<t-o;u++)s+="0";return i[1]=s,i},d})